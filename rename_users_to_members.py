#!/usr/bin/env python3
"""
å°‡ç³»çµ±ä¸­çš„ã€Œç”¨æˆ¶ã€çµ±ä¸€æ”¹ç¨±ç‚ºã€Œæˆå“¡ã€æˆ–ã€Œåœ˜éšŠæˆå“¡ã€
ä¿ç•™æŠ€è¡“è¡“èªä¸­çš„ user (å¦‚ user_id, username ç­‰)
"""
import re
from pathlib import Path

# æ›¿æ›è¦å‰‡: (åŸæ–‡, æ–°æ–‡, èªªæ˜)
REPLACEMENTS = [
    # å¾Œå°UIç›¸é—œ
    ("ç”¨æˆ¶ç®¡ç†", "æˆå“¡ç®¡ç†", "ç®¡ç†åŠŸèƒ½åç¨±"),
    ("ç”¨æˆ¶åˆ—è¡¨", "æˆå“¡åˆ—è¡¨", "åˆ—è¡¨æ¨™é¡Œ"),
    ("ç”¨æˆ¶åç¨±", "æˆå“¡åç¨±", "æ¬„ä½åç¨±"),
    ("ç”¨æˆ¶è¡Œ", "æˆå“¡è¡Œ", "è¡¨æ ¼è¡Œ"),
    ("åŸ·è¡Œç”¨æˆ¶", "åŸ·è¡Œæˆå“¡", "æ“ä½œè€…"),
    ("å…¨éƒ¨ç”¨æˆ¶", "å…¨éƒ¨æˆå“¡", "ç¯©é¸é¸é …"),
    ("ç”¨æˆ¶æ“ä½œ", "æˆå“¡æ“ä½œ", "æ“ä½œè¨˜éŒ„"),
    ("ç”¨æˆ¶å¸³è™Ÿ", "æˆå“¡å¸³è™Ÿ", "å¸³æˆ¶ç›¸é—œ"),
    ("ç”¨æˆ¶è§’è‰²", "æˆå“¡è§’è‰²", "è§’è‰²ç®¡ç†"),
    ("ç”¨æˆ¶æ¬Šé™", "æˆå“¡æ¬Šé™", "æ¬Šé™ç›¸é—œ"),
    ("ç•¶å‰ç”¨æˆ¶", "ç•¶å‰æˆå“¡", "ç•¶å‰ç™»å…¥è€…"),
    ("ç™»å…¥ç”¨æˆ¶", "ç™»å…¥æˆå“¡", "ç™»å…¥ç‹€æ…‹"),
    ("è©²ç”¨æˆ¶", "è©²æˆå“¡", "æŒ‡ç¨±ç‰¹å®šå°è±¡"),
    ("æ­¤ç”¨æˆ¶", "æ­¤æˆå“¡", "æŒ‡ç¨±ç‰¹å®šå°è±¡"),
    ("ç›®æ¨™ç”¨æˆ¶", "ç›®æ¨™æˆå“¡", "æ“ä½œå°è±¡"),
    ("ç³»çµ±ç”¨æˆ¶", "ç³»çµ±æˆå“¡", "ç³»çµ±å…§çš„ä½¿ç”¨è€…"),
    ("ä½ç”¨æˆ¶", "ä½æˆå“¡", "è¨ˆæ•¸å–®ä½"),
    ("å€‹ç”¨æˆ¶", "å€‹æˆå“¡", "è¨ˆæ•¸å–®ä½"),
    ("æ–°ç”¨æˆ¶", "æ–°æˆå“¡", "æ–°åŠ å…¥è€…"),
    ("æ‰€æœ‰ç”¨æˆ¶", "æ‰€æœ‰æˆå“¡", "å…¨é«”"),
    ("ä»»ä½•ç”¨æˆ¶", "ä»»ä½•æˆå“¡", "ä»»æ„ä¸€ä½"),
    ("ç”¨æˆ¶çš„", "æˆå“¡çš„", "æ‰€å±¬é—œä¿‚"),
    ("ç”¨æˆ¶æ¶ˆå¤±", "æˆå“¡æ¶ˆå¤±", "åˆªé™¤çµæœ"),
    ("ç”¨æˆ¶å‰µå»º", "æˆå“¡å‰µå»º", "å»ºç«‹è€…"),
    ("ç”¨æˆ¶åŠå…¶", "æˆå“¡åŠå…¶", "é€£å¸¶é—œä¿‚"),
    ("ç”¨æˆ¶é«˜äº®", "æˆå“¡é«˜äº®", "UIæ•ˆæœ"),
    ("ç”¨æˆ¶ç°è‰²", "æˆå“¡ç°è‰²", "UIæ•ˆæœ"),
    ("ç”¨æˆ¶æ´»å‹•", "æˆå“¡æ´»å‹•", "æ´»å‹•è¨˜éŒ„"),
    ("ç”¨æˆ¶è©³ç´°", "æˆå“¡è©³ç´°", "è©³ç´°è³‡æ–™"),
    ("ç”¨æˆ¶è¿½è¹¤", "æˆå“¡è¿½è¹¤", "è¿½è¹¤åŠŸèƒ½"),
    ("ç”¨æˆ¶é¸æ“‡", "æˆå“¡é¸æ“‡", "é¸æ“‡åŠŸèƒ½"),
    ("ç”¨æˆ¶æ•¸é‡", "æˆå“¡æ•¸é‡", "çµ±è¨ˆ"),
    ("ç”¨æˆ¶çµ±è¨ˆ", "æˆå“¡çµ±è¨ˆ", "çµ±è¨ˆåŠŸèƒ½"),
    ("åœç”¨ç”¨æˆ¶", "åœç”¨æˆå“¡", "æ“ä½œ"),
    ("åˆªé™¤ç”¨æˆ¶", "åˆªé™¤æˆå“¡", "æ“ä½œ"),
    ("å•Ÿç”¨ç”¨æˆ¶", "å•Ÿç”¨æˆå“¡", "æ“ä½œ"),
    ("ç®¡ç†å“¡ç®¡ç†ç³»çµ±å…§çš„æ‰€æœ‰ç”¨æˆ¶", "ç®¡ç†å“¡ç®¡ç†ç³»çµ±å…§çš„æ‰€æœ‰æˆå“¡", "åŠŸèƒ½æè¿°"),
    ("ç®¡ç†ç³»çµ±ç”¨æˆ¶", "ç®¡ç†ç³»çµ±æˆå“¡", "åŠŸèƒ½æ¨™é¡Œ"),
    ("æ›´æ–°ç”¨æˆ¶", "æ›´æ–°æˆå“¡", "æ“ä½œ"),
    ("åˆ‡æ›ç”¨æˆ¶", "åˆ‡æ›æˆå“¡", "æ“ä½œ"),
    ("å…è¨±ç”¨æˆ¶", "å…è¨±æˆå“¡", "æ¬Šé™æè¿°"),
    ("ç”¨æˆ¶è¨»å†Š", "æˆå“¡è¨»å†Š", "è¨»å†Šç›¸é—œ"),
    ("ç¸½ç”¨æˆ¶æ•¸", "ç¸½æˆå“¡æ•¸", "çµ±è¨ˆ"),
    ("ç²å–æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨", "ç²å–æ‰€æœ‰æˆå“¡åˆ—è¡¨", "ç¨‹å¼è¨»è§£"),
    ("æ‰¾å‡ºç•¶å‰ç”¨æˆ¶", "æ‰¾å‡ºç•¶å‰æˆå“¡", "ç¨‹å¼è¨»è§£"),
    ("ç‚ºæ¯å€‹ç”¨æˆ¶", "ç‚ºæ¯å€‹æˆå“¡", "ç¨‹å¼è¨»è§£"),
    ("è¨ˆç®—ç”¨æˆ¶çš„", "è¨ˆç®—æˆå“¡çš„", "ç¨‹å¼è¨»è§£"),
    ("åªæ›´æ–°é ­åƒ hash,ä¸æ›´æ–°ç”¨æˆ¶åç¨±", "åªæ›´æ–°é ­åƒ hash,ä¸æ›´æ–°æˆå“¡åç¨±", "ç¨‹å¼è¨»è§£"),
    ("æ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥", "æ‰€æœ‰æˆå“¡éƒ½å¯ä»¥", "æ¬Šé™èªªæ˜"),
    ("ç”¨æˆ¶å¯å»ºç«‹", "æˆå“¡å¯å»ºç«‹", "æ¬Šé™æè¿°"),
    ("ç”¨æˆ¶å¯ä»¥", "æˆå“¡å¯ä»¥", "æ¬Šé™æè¿°"),
]

# éœ€è¦æ’é™¤çš„æ¨¡å¼ (æŠ€è¡“è¡“èªä¿æŒä¸è®Š)
EXCLUDE_PATTERNS = [
    r'user_id',
    r'user_key',
    r'username',
    r'user_agent',
    r'admin_user',
    r'auth_user',
    r'sample_user',
    r'_user_',
    r'User-agent',
    r'\.user\.',
    r'users\.',
    r'{% for user in',
    r'{{ user\.',
    r'data-user',
    r'#user',
    r'user-',  # CSS class
    r'ç”¨æˆ¶å',  # username ä¿æŒåŸæ¨£
]

def should_replace(line: str, old_text: str) -> bool:
    """æª¢æŸ¥æ˜¯å¦æ‡‰è©²æ›¿æ›æ­¤è¡Œ"""
    # æª¢æŸ¥æ˜¯å¦åŒ¹é…æ’é™¤æ¨¡å¼
    for pattern in EXCLUDE_PATTERNS:
        if re.search(pattern, line, re.IGNORECASE):
            # å¦‚æœæ’é™¤æ¨¡å¼å°±åœ¨è¦æ›¿æ›çš„æ–‡å­—é™„è¿‘,å‰‡è·³é
            if old_text in line:
                idx = line.find(old_text)
                context = line[max(0, idx-20):min(len(line), idx+len(old_text)+20)]
                for pattern in EXCLUDE_PATTERNS:
                    if re.search(pattern, context):
                        return False
    return True

def replace_in_file(file_path: Path) -> tuple[int, list[str]]:
    """åœ¨æª”æ¡ˆä¸­åŸ·è¡Œæ›¿æ›,è¿”å› (æ›¿æ›æ¬¡æ•¸, æ›¿æ›è©³æƒ…åˆ—è¡¨)"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        original_content = content
        replacements_made = []
        
        for old_text, new_text, description in REPLACEMENTS:
            # è¨ˆç®—æ›¿æ›æ¬¡æ•¸
            count = content.count(old_text)
            if count > 0:
                # åŸ·è¡Œæ›¿æ›
                content = content.replace(old_text, new_text)
                replacements_made.append(f"  {old_text} â†’ {new_text} ({count}æ¬¡)")
        
        # å¦‚æœæœ‰ä¿®æ”¹,å¯«å›æª”æ¡ˆ
        if content != original_content:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            return len(replacements_made), replacements_made
        
        return 0, []
    except Exception as e:
        print(f"âŒ è™•ç† {file_path} æ™‚å‡ºéŒ¯: {e}")
        return 0, []

def main():
    """ä¸»å‡½æ•¸"""
    print("ğŸ”„ é–‹å§‹æ›¿æ›ã€Œç”¨æˆ¶ã€â†’ã€Œæˆå“¡ã€...")
    print()
    
    # è¦è™•ç†çš„æª”æ¡ˆé¡å‹å’Œç›®éŒ„
    patterns = [
        'app/templates/**/*.html',
        'app/admin/*.py',
        'app/auth/*.py',
        'app/forms.py',
        'docs/*.md',
        'README.md',
    ]
    
    project_root = Path(__file__).parent
    total_files = 0
    total_replacements = 0
    
    for pattern in patterns:
        for file_path in project_root.glob(pattern):
            if file_path.is_file():
                count, details = replace_in_file(file_path)
                if count > 0:
                    total_files += 1
                    total_replacements += count
                    print(f"âœ… {file_path.relative_to(project_root)}")
                    for detail in details:
                        print(detail)
                    print()
    
    print("=" * 60)
    print(f"âœ… å®Œæˆ!")
    print(f"ğŸ“ ä¿®æ”¹äº† {total_files} å€‹æª”æ¡ˆ")
    print(f"ğŸ”„ åŸ·è¡Œäº† {total_replacements} é …æ›¿æ›")
    print()
    print("âš ï¸ æ³¨æ„: æŠ€è¡“è¡“èª (user_id, username ç­‰) å·²ä¿ç•™")

if __name__ == "__main__":
    main()
