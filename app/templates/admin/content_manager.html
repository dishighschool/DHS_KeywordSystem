{% extends "admin/base.html" %}
{% block title %}內容管理{% endblock %}
{% block header_title %}內容管理{% endblock %}
{% block page_icon_class %}bi bi-grid-3x3-gap{% endblock %}
{% block page_title %}內容管理中心{% endblock %}
{% block page_subtitle %}高效管理分類與關鍵字內容{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/icon-picker.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/content-manager.css') }}">
{% endblock %}

{% block content %}

<div class="content-manager-toolbar sticky-top bg-white border-bottom shadow-sm mb-4 py-3">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
    
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <button class="btn btn-success" onclick="window.location.href='{{ url_for('admin.create_keyword_studio') }}'">
        <i class="bi bi-plus-lg me-1"></i> 建立關鍵字
      </button>
      {% if current_user.is_admin() %}
      <button class="btn btn-primary" onclick="openCategoryModal()">
        <i class="bi bi-folder-plus me-1"></i> 新增分類
      </button>
      {% endif %}
      <div class="vr"></div>
      <button class="btn btn-outline-secondary" id="toggleBatchMode">
        <i class="bi bi-check-square me-1"></i> 批次操作
      </button>
    </div>
    
    
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-funnel me-1"></i> 篩選
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><h6 class="dropdown-header">顯示狀態</h6></li>
          <li><a class="dropdown-item" href="#" data-filter="all">全部內容</a></li>
          <li><a class="dropdown-item" href="#" data-filter="public">僅公開</a></li>
          <li><a class="dropdown-item" href="#" data-filter="private">僅隱藏</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><h6 class="dropdown-header">排序方式</h6></li>
          <li><a class="dropdown-item" href="#" data-sort="position">自訂順序</a></li>
          <li><a class="dropdown-item" href="#" data-sort="created">建立時間</a></li>
          <li><a class="dropdown-item" href="#" data-sort="updated">更新時間</a></li>
          <li><a class="dropdown-item" href="#" data-sort="views">觀看次數</a></li>
        </ul>
      </div>
      <div class="input-group" style="max-width: 300px;">
        <input type="text" class="form-control" id="contentSearch" placeholder="搜尋關鍵字...">
        <button class="btn btn-outline-secondary" type="button">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
  </div>
  
  
  <div id="batchToolbar" class="mt-3 p-3 bg-primary bg-opacity-10 rounded" style="display: none;">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-check-square-fill fs-5 text-primary"></i>
        <span class="fw-semibold">已選擇 <span id="selectedCount">0</span> 筆項目</span>
      </div>
      <div class="btn-group">
        <button class="btn btn-sm btn-success" onclick="batchAction('publish')">
          <i class="bi bi-eye me-1"></i>公開
        </button>
        <button class="btn btn-sm btn-warning" onclick="batchAction('unpublish')">
          <i class="bi bi-eye-slash me-1"></i>隱藏
        </button>
        <button class="btn btn-sm btn-info" onclick="batchAction('move')">
          <i class="bi bi-folder-symlink me-1"></i>移動
        </button>
        {% if current_user.is_admin() %}
        <button class="btn btn-sm btn-danger" onclick="batchAction('delete')">
          <i class="bi bi-trash me-1"></i>刪除
        </button>
        {% endif %}
        <button class="btn btn-sm btn-outline-secondary" onclick="clearBatchSelection()">
          <i class="bi bi-x-lg me-1"></i>取消
        </button>
      </div>
    </div>
  </div>
</div>

<div class="stats-bar mb-3">
  <div class="stat-item-inline">
    <i class="bi bi-folder2-open text-primary"></i>
    <span class="stat-number">{{ categories|length }}</span>
    <span class="stat-text">分類</span>
  </div>
  <div class="stat-divider"></div>
  <div class="stat-item-inline">
    <i class="bi bi-file-text text-success"></i>
    <span class="stat-number">{{ total_keywords }}</span>
    <span class="stat-text">關鍵字</span>
  </div>
  <div class="stat-divider"></div>
  <div class="stat-item-inline">
    <i class="bi bi-eye text-info"></i>
    <span class="stat-number">{{ public_keywords }}</span>
    <span class="stat-text">公開</span>
  </div>
  <div class="stat-divider"></div>
  <div class="stat-item-inline">
    <i class="bi bi-eye-slash text-warning"></i>
    <span class="stat-number">{{ total_keywords - public_keywords }}</span>
    <span class="stat-text">隱藏</span>
  </div>
</div>

<div id="contentManagerMain">
  {% if categories %}
    {% for category in categories %}
    <div class="category-section" data-category-id="{{ category.id }}">
      
      <div class="category-header" onclick="toggleCategoryContent({{ category.id }})">
        <div class="category-header-left">
          {% if current_user.is_admin() %}
          <div class="drag-handle-category" title="拖動排序" onclick="event.stopPropagation();">
            <i class="bi bi-grip-vertical"></i>
          </div>
          {% endif %}
          <div class="category-toggle">
            <i class="bi bi-chevron-right" id="chevron-{{ category.id }}"></i>
          </div>
          <div class="category-icon">
            <i class="{{ category.icon or 'bi-folder' }} fs-4"></i>
          </div>
          <div class="category-info">
            <h3 class="category-title">
              {{ category.name }}
              {% if not category.is_public %}
              <span class="badge bg-warning text-dark ms-2">
                <i class="bi bi-eye-slash"></i> 隱藏
              </span>
              {% endif %}
            </h3>
            {% if category.description %}
            <p class="category-description">{{ category.description }}</p>
            {% endif %}
          </div>
        </div>
        <div class="category-header-right" onclick="event.stopPropagation();">
          <span class="badge bg-light text-dark px-3 py-2">
            <i class="bi bi-file-text me-1"></i>{{ category.keywords|length }} 筆
          </span>
          {% if current_user.is_admin() %}
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="editCategory({{ category.id }})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger" onclick="deleteCategory({{ category.id }}, '{{ category.name }}', {{ category.keywords|length }})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          {% endif %}
        </div>
      </div>
      
      
      <div class="category-content" id="category-content-{{ category.id }}" style="display: none;">
        {% if category.keywords %}
        <div class="keywords-table">
          
          <div class="keywords-table-header">
            <div class="col-checkbox batch-mode-only">
              <input type="checkbox" class="form-check-input" onchange="toggleCategorySelection({{ category.id }}, this.checked)">
            </div>
            <div class="col-drag"></div>
            <div class="col-title">標題</div>
            <div class="col-status">狀態</div>
            <div class="col-stats">統計</div>
            <div class="col-date">日期</div>
            <div class="col-actions">操作</div>
          </div>
          
          
          <div class="keywords-list sortable-keywords" data-category-id="{{ category.id }}">
            {% for keyword in category.keywords %}
            <div class="keyword-row" data-keyword-id="{{ keyword.id }}" data-public="{{ keyword.is_public|lower }}" {% if current_user.is_admin() %}draggable="true"{% endif %}>
              <div class="col-checkbox batch-mode-only">
                <input type="checkbox" class="keyword-checkbox form-check-input" value="{{ keyword.id }}" onchange="updateBatchSelection()">
              </div>
              <div class="col-drag">
                {% if current_user.is_admin() %}
                <div class="drag-handle" title="拖動排序或拖到分類標題上移動">
                  <i class="bi bi-grip-vertical"></i>
                </div>
                {% endif %}
              </div>
              <div class="col-title">
                <div class="keyword-title-cell">
                  <i class="bi bi-file-text text-primary me-2"></i>
                  <div class="keyword-title-content">
                    <a href="{{ url_for('admin.edit_keyword_studio', keyword_id=keyword.id) }}" class="keyword-title-link">
                      {{ keyword.title }}
                    </a>
                    {% if keyword.description_markdown %}
                    <div class="keyword-description-preview">
                      {{ keyword.description_markdown|striptags|truncate(80) }}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="mobile-meta-row">
                <div class="mobile-status-stats-row">
                  <div class="col-status">
                    <div class="dropdown">
                      <button class="status-dropdown-btn {% if keyword.is_public %}status-public{% else %}status-private{% endif %}" 
                              type="button" 
                              data-bs-toggle="dropdown" 
                              aria-expanded="false"
                              data-keyword-id="{{ keyword.id }}"
                              data-current-status="{{ 'true' if keyword.is_public else 'false' }}">
                        {% if keyword.is_public %}
                        <i class="bi bi-eye"></i> 公開
                        {% else %}
                        <i class="bi bi-eye-slash"></i> 隱藏
                        {% endif %}
                        <i class="bi bi-chevron-down ms-1" style="font-size: 0.7rem;"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-sm">
                        <li>
                          <a class="dropdown-item status-option-public {% if keyword.is_public %}active{% endif %}" 
                             href="#" 
                             data-status="true"
                             onclick="changeKeywordVisibility({{ keyword.id }}, true, event)">
                            <i class="bi bi-eye text-success me-2"></i>公開
                            {% if keyword.is_public %}<i class="bi bi-check-lg ms-auto text-primary"></i>{% endif %}
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item status-option-private {% if not keyword.is_public %}active{% endif %}" 
                             href="#" 
                             data-status="false"
                             onclick="changeKeywordVisibility({{ keyword.id }}, false, event)">
                            <i class="bi bi-eye-slash text-warning me-2"></i>隱藏
                            {% if not keyword.is_public %}<i class="bi bi-check-lg ms-auto text-primary"></i>{% endif %}
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                  <div class="col-stats">
                    <div class="keyword-stats">
                      <span class="stat-item" title="觀看次數">
                        <i class="bi bi-eye-fill text-info"></i> {{ keyword.view_count }}
                      </span>
                      {% if keyword.videos %}
                      <span class="stat-item" title="影片數量">
                        <i class="bi bi-camera-video text-danger"></i> {{ keyword.videos|length }}
                      </span>
                      {% endif %}
                      {% if keyword.aliases %}
                      <span class="stat-item" title="別名數量">
                        <i class="bi bi-tags text-primary"></i> {{ keyword.aliases|length }}
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="col-date d-none d-md-block">
                  <div class="keyword-dates">
                    <div class="date-item">
                      <i class="bi bi-clock me-1"></i>
                      <span title="更新時間">{{ keyword.updated_at.strftime('%Y-%m-%d') }}</span>
                    </div>
                    <div class="date-author">
                      <i class="bi bi-person-circle me-1"></i>{{ keyword.author.username }}
                    </div>
                  </div>
                </div>
                <div class="col-actions">
                  <div class="btn-group btn-group-sm">
                    <a class="btn btn-outline-secondary" href="{{ url_for('main.keyword_detail', category_slug=keyword.category.slug, slug=keyword.slug) }}" target="_blank" title="前台檢視">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a class="btn btn-primary" href="{{ url_for('admin.edit_keyword', keyword_id=keyword.id) }}" title="編輯">
                      <i class="bi bi-pencil"></i>
                    </a>
                    {% if current_user.is_admin() %}
                    <button class="btn btn-danger" onclick="deleteKeyword({{ keyword.id }}, '{{ keyword.title }}')" title="刪除">
                      <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% else %}
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <p>此分類尚無關鍵字</p>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  {% else %}
  <div class="empty-state-large">
    <i class="bi bi-folder-x"></i>
    <h3>尚未建立任何分類</h3>
    <p>請先建立分類才能開始管理內容</p>
    {% if current_user.is_admin() %}
    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#quickCreateCategoryModal">
      <i class="bi bi-folder-plus me-2"></i> 建立第一個分類
    </button>
    {% endif %}
  </div>
  {% endif %}
</div>

{% if current_user.is_admin() %}

<div class="modal fade" id="categoryModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalTitle">
          <i class="bi bi-folder-plus me-2"></i>新增分類
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="categoryForm" method="post" action="/admin/categories/quick-create">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="categoryId" name="category_id" value="">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">分類名稱 <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-lg" id="categoryName" name="name" required placeholder="例如:程式設計">
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-semibold">圖示</label>
            <input type="hidden" id="categoryIconInput" name="icon" value="">
            
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-semibold">描述</label>
            <textarea class="form-control" id="categoryDescription" name="description" rows="3" placeholder="說明此分類的用途"></textarea>
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="categoryIsPublic" name="is_public" checked style="width: 3em; height: 1.5em;">
              <label class="form-check-label fw-semibold ms-2" for="categoryIsPublic">公開顯示</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary" id="categorySubmitBtn">
            <i class="bi bi-check-circle me-1"></i>建立分類
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="quickCreateCategoryModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">請使用新的分類管理介面</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>分類管理已整合到內容管理中心,請使用「新增分類」按鈕。</p>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="modal fade" id="quickCreateKeywordModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-lg me-2"></i>新增關鍵字
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{{ url_for('admin.quick_create_keyword') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label fw-semibold">關鍵字標題 <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-lg" name="title" required placeholder="輸入關鍵字名稱">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">所屬分類 <span class="text-danger">*</span></label>
              <select class="form-select form-select-lg" name="category_id" id="quickCategorySelect" required>
                <option value="">請選擇...</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">內容描述</label>
            <textarea class="form-control" name="description_markdown" rows="4" placeholder="使用 Markdown 格式撰寫關鍵字說明..."></textarea>
            <small class="text-muted">支援 Markdown 語法,稍後可編輯補充</small>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="is_public" checked style="width: 3em; height: 1.5em;">
            <label class="form-check-label fw-semibold ms-2">立即公開</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-plus-circle me-1"></i>建立關鍵字
          </button>
          <button type="submit" name="continue_edit" value="1" class="btn btn-primary">
            <i class="bi bi-pencil me-1"></i>建立並繼續編輯
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="batchMoveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-folder-symlink me-2"></i>批次移動關鍵字
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">將選擇的 <strong><span id="moveCount">0</span></strong> 筆關鍵字移動到:</p>
        <select class="form-select form-select-lg" id="batchMoveTarget">
          <option value="">請選擇目標分類...</option>
          {% for category in categories %}
          <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="confirmBatchMove()">
          <i class="bi bi-check-circle me-1"></i>確認移動
        </button>
      </div>
    </div>
  </div>
</div>

<form id="deleteForm" method="post" style="display: none;">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
  // 傳遞成員權限資訊到 JavaScript
  window.userIsAdmin = {{ 'true' if current_user.is_admin() else 'false' }};
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/icon-picker.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-manager.js') }}"></script>
{% endblock %}
