{% extends "admin/base.html" %}
{% block title %}ç·¨è¼¯æ—¥èªŒ{% endblock %}
{% block header_title %}ç·¨è¼¯æ—¥èªŒ{% endblock %}
{% block page_icon_class %}bi bi-clock-history{% endblock %}
{% block page_title %}ç·¨è¼¯æ—¥èªŒ{% endblock %}
{% block page_subtitle %}æŸ¥çœ‹æ‰€æœ‰æˆå“¡çš„ç·¨è¼¯æ“ä½œè¨˜éŒ„{% endblock %}

{% block content %}
<style>
  /* ç·Šæ¹Šå‹å¡ç‰‡ */
  .compact-stats {
    padding: 0.75rem;
  }
  .compact-stats i {
    font-size: 1.5rem;
  }
  .compact-stats h4 {
    font-size: 1.25rem;
    margin: 0.25rem 0;
  }
  .compact-stats small {
    font-size: 0.75rem;
  }
  
  /* ç”¨æˆ¶åæˆªæ–· */
  .user-cell {
    max-width: 120px;
  }
  .user-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px;
    display: inline-block;
    vertical-align: middle;
  }
  .user-avatar {
    width: 20px;
    height: 20px;
    font-size: 10px;
  }
  
  /* ç·Šæ¹Šå‹è¡¨æ ¼ */
  .compact-table {
    font-size: 0.875rem;
  }
  .compact-table th,
  .compact-table td {
    padding: 0.5rem;
    vertical-align: middle;
  }
  .compact-table .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
  }
  
  /* æè¿°æ¬„ä½æˆªæ–· */
  .description-cell {
    max-width: 300px;
  }
  .description-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* æœç´¢æ¡†æ¨£å¼ */
  .search-input-group {
    position: relative;
  }
  .search-input-group .form-control {
    padding-right: 2.5rem;
  }
  .search-clear-btn {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: none;
    color: #6c757d;
    cursor: pointer;
    z-index: 10;
  }
  .search-clear-btn:hover {
    color: #dc3545;
  }
</style>

<div class="admin-card mb-3">
  <div class="admin-card-body">
    <form method="get" action="{{ url_for('admin.view_edit_logs') }}" class="row g-2" id="filterForm">
      
      <div class="col-md-2">
        <label class="form-label fw-semibold small">æ“ä½œé¡å‹</label>
        <select name="action" class="form-select form-select-sm">
          <option value="">å…¨éƒ¨</option>
          <option value="create" {% if action_filter == 'create' %}selected{% endif %}>å»ºç«‹</option>
          <option value="update" {% if action_filter == 'update' %}selected{% endif %}>æ›´æ–°</option>
          <option value="delete" {% if action_filter == 'delete' %}selected{% endif %}>åˆªé™¤</option>
          <option value="publish" {% if action_filter == 'publish' %}selected{% endif %}>å…¬é–‹</option>
          <option value="unpublish" {% if action_filter == 'unpublish' %}selected{% endif %}>éš±è—</option>
          <option value="move" {% if action_filter == 'move' %}selected{% endif %}>ç§»å‹•</option>
        </select>
      </div>
      
      <div class="col-md-2">
        <label class="form-label fw-semibold small">ç›®æ¨™é¡å‹</label>
        <select name="target" class="form-select form-select-sm">
          <option value="">å…¨éƒ¨</option>
          <option value="keyword" {% if target_filter == 'keyword' %}selected{% endif %}>é—œéµå­—</option>
          <option value="category" {% if target_filter == 'category' %}selected{% endif %}>åˆ†é¡</option>
          <option value="user" {% if target_filter == 'user' %}selected{% endif %}>ç”¨æˆ¶</option>
          <option value="announcement" {% if target_filter == 'announcement' %}selected{% endif %}>å…¬å‘Š</option>
        </select>
      </div>
      
      <div class="col-md-2">
        <label class="form-label fw-semibold small">åŸ·è¡Œæˆå“¡</label>
        <select name="user" class="form-select form-select-sm" id="userSelect">
          <option value="">å…¨éƒ¨æˆå“¡</option>
          {% for user in users %}
          <option value="{{ user.id }}" {% if user_filter == user.id %}selected{% endif %} 
                  data-username="{{ user.username }}"
                  data-is-admin="{{ user.is_admin() }}">
            {{ user.username }}{% if user.is_admin() %} ğŸ‘‘{% endif %}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-2">
        <label class="form-label fw-semibold small">é–‹å§‹æ—¥æœŸ</label>
        <input type="date" name="start_date" class="form-control form-control-sm" 
               value="{{ start_date or '' }}">
      </div>
      
      <div class="col-md-2">
        <label class="form-label fw-semibold small">çµæŸæ—¥æœŸ</label>
        <input type="date" name="end_date" class="form-control form-control-sm" 
               value="{{ end_date or '' }}">
      </div>
      
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary btn-sm w-100">
          <i class="bi bi-funnel me-1"></i>ç¯©é¸
        </button>
      </div>
      
      
      <div class="col-md-10">
        <label class="form-label fw-semibold small">æœç´¢æè¿°æˆ–ç›®æ¨™åç¨±</label>
        <div class="search-input-group">
          <input type="text" name="search" class="form-control form-control-sm" 
                 placeholder="è¼¸å…¥é—œéµå­—æœç´¢..." 
                 value="{{ search_query or '' }}"
                 id="searchInput">
          {% if search_query %}
          <button type="button" class="search-clear-btn" id="clearSearch">
            <i class="bi bi-x-circle-fill"></i>
          </button>
          {% endif %}
        </div>
      </div>
      
      <div class="col-md-2 d-flex align-items-end">
        <a href="{{ url_for('admin.view_edit_logs') }}" class="btn btn-outline-secondary btn-sm w-100">
          <i class="bi bi-arrow-counterclockwise me-1"></i>é‡ç½®
        </a>
      </div>
    </form>
  </div>
</div>

<div class="row mb-3 g-2">
  <div class="col-6 col-md-3">
    <div class="admin-card">
      <div class="admin-card-body text-center compact-stats">
        <i class="bi bi-list-ul text-primary"></i>
        <h4 class="mb-0 fw-bold">{{ logs.total }}</h4>
        <small class="text-muted">ç¸½è¨˜éŒ„æ•¸</small>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="admin-card">
      <div class="admin-card-body text-center compact-stats">
        <i class="bi bi-file-text text-success"></i>
        <h4 class="mb-0 fw-bold">{{ stats.keyword_count }}</h4>
        <small class="text-muted">é—œéµå­—æ“ä½œ</small>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="admin-card">
      <div class="admin-card-body text-center compact-stats">
        <i class="bi bi-folder text-info"></i>
        <h4 class="mb-0 fw-bold">{{ stats.category_count }}</h4>
        <small class="text-muted">åˆ†é¡æ“ä½œ</small>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="admin-card">
      <div class="admin-card-body text-center compact-stats">
        <i class="bi bi-people text-warning"></i>
        <h4 class="mb-0 fw-bold">{{ stats.user_count }}</h4>
        <small class="text-muted">æˆå“¡æ“ä½œ</small>
      </div>
    </div>
  </div>
</div>

<div class="admin-card">
  <div class="admin-card-header d-flex justify-content-between align-items-center">
    <h3 class="admin-card-title mb-0">
      <i class="bi bi-list admin-card-icon"></i>
      æ“ä½œè¨˜éŒ„
      {% if search_query %}
      <span class="badge bg-info ms-2">æœç´¢: {{ search_query }}</span>
      {% endif %}
    </h3>
    <div class="d-flex gap-2 align-items-center">
      <small class="text-muted">é¡¯ç¤º {{ logs.items|length }} ç­†</small>
      <span class="badge bg-secondary">ç¬¬ {{ logs.page }} / {{ logs.pages }} é </span>
    </div>
  </div>
  <div class="admin-card-body p-0">
    {% if logs.items %}
    <div class="table-responsive">
      <table class="table table-hover mb-0 compact-table">
        <thead class="table-light">
          <tr>
            <th style="width: 130px;">æ™‚é–“</th>
            <th style="width: 110px;">ç”¨æˆ¶</th>
            <th style="width: 85px;">æ“ä½œ</th>
            <th style="width: 95px;">é¡å‹</th>
            <th>æè¿°</th>
            <th style="width: 110px;">IP</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs.items %}
          <tr>
            <td>
              <small class="text-muted">
                {{ log.created_at.strftime('%m/%d %H:%M:%S') }}
              </small>
            </td>
            <td class="user-cell">
              <div class="d-flex align-items-center">
                <img src="{{ log.user.get_avatar_url(40) }}" class="rounded-circle me-1 user-avatar" 
                     title="{{ log.user.username }}">
                <div class="overflow-hidden">
                  <div class="user-name fw-semibold" title="{{ log.user.username }}">
                    {{ log.user.username }}
                  </div>
                  {% if log.user.is_admin() %}
                  <span class="badge bg-danger" style="font-size: 0.6rem; padding: 0.1rem 0.3rem;">ç®¡ç†å“¡</span>
                  {% endif %}
                </div>
              </div>
            </td>
            <td>
              {% if log.action.value == 'create' %}
              <span class="badge bg-success"><i class="bi bi-plus-circle"></i> å»ºç«‹</span>
              {% elif log.action.value == 'update' %}
              <span class="badge bg-primary"><i class="bi bi-pencil"></i> æ›´æ–°</span>
              {% elif log.action.value == 'delete' %}
              <span class="badge bg-danger"><i class="bi bi-trash"></i> åˆªé™¤</span>
              {% elif log.action.value == 'publish' %}
              <span class="badge bg-info"><i class="bi bi-eye"></i> å…¬é–‹</span>
              {% elif log.action.value == 'unpublish' %}
              <span class="badge bg-warning text-dark"><i class="bi bi-eye-slash"></i> éš±è—</span>
              {% elif log.action.value == 'move' %}
              <span class="badge bg-secondary"><i class="bi bi-arrow-right"></i> ç§»å‹•</span>
              {% else %}
              <span class="badge bg-light text-dark">{{ log.action.value }}</span>
              {% endif %}
            </td>
            <td>
              <small>
              {% if log.target_type.value == 'keyword' %}
              <i class="bi bi-file-text text-primary"></i> é—œéµå­—
              {% elif log.target_type.value == 'category' %}
              <i class="bi bi-folder text-info"></i> åˆ†é¡
              {% elif log.target_type.value == 'user' %}
              <i class="bi bi-person text-warning"></i> ç”¨æˆ¶
              {% elif log.target_type.value == 'announcement' %}
              <i class="bi bi-megaphone text-danger"></i> å…¬å‘Š
              {% else %}
              {{ log.target_type.value }}
              {% endif %}
              </small>
            </td>
            <td class="description-cell">
              <div class="description-text" title="{{ log.description }}{% if log.target_name %} - {{ log.target_name }}{% endif %}">
                {{ log.description }}
                {% if log.target_name %}
                <small class="text-muted">- {{ log.target_name }}</small>
                {% endif %}
              </div>
            </td>
            <td>
              <small class="text-muted font-monospace" style="font-size: 0.75rem;">
                {{ log.ip_address or 'æœªçŸ¥' }}
              </small>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    
    {% if logs.pages > 1 %}
    <div class="p-3 border-top">
      <nav>
        <ul class="pagination pagination-sm mb-0 justify-content-center">
          {% if logs.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin.view_edit_logs', page=logs.prev_num, action=action_filter, target=target_filter, user=user_filter) }}">ä¸Šä¸€é </a>
          </li>
          {% endif %}
          
          {% for page_num in logs.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
              <li class="page-item {% if page_num == logs.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('admin.view_edit_logs', page=page_num, action=action_filter, target=target_filter, user=user_filter) }}">{{ page_num }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
          {% endfor %}
          
          {% if logs.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin.view_edit_logs', page=logs.next_num, action=action_filter, target=target_filter, user=user_filter) }}">ä¸‹ä¸€é </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
    
    {% else %}
    <div class="text-center py-5">
      <i class="bi bi-inbox fs-1 text-muted"></i>
      <p class="text-muted mt-3">
        {% if search_query or action_filter or target_filter or user_filter or start_date or end_date %}
        æ‰¾ä¸åˆ°ç¬¦åˆç¯©é¸æ¢ä»¶çš„è¨˜éŒ„
        {% else %}
        å°šç„¡ç·¨è¼¯è¨˜éŒ„
        {% endif %}
      </p>
    </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // æ¸…é™¤æœç´¢æŒ‰éˆ•
  const clearSearchBtn = document.getElementById('clearSearch');
  if (clearSearchBtn) {
    clearSearchBtn.addEventListener('click', function() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterForm').submit();
    });
  }
  
  // æˆå“¡é¸æ“‡æ¡†æœç´¢åŠŸèƒ½
  const userSelect = document.getElementById('userSelect');
  if (userSelect && userSelect.options.length > 20) {
    // å¦‚æœç”¨æˆ¶è¶…é20å€‹,æ·»åŠ æœç´¢æç¤º
    userSelect.setAttribute('title', 'å¯ä»¥è¼¸å…¥ç”¨æˆ¶åé€²è¡Œæœç´¢');
    
    // ç°¡å–®çš„éµç›¤æœç´¢
    let searchBuffer = '';
    let searchTimeout;
    
    userSelect.addEventListener('keydown', function(e) {
      if (e.key.length === 1) {
        searchBuffer += e.key.toLowerCase();
        
        // æŸ¥æ‰¾åŒ¹é…çš„é¸é …
        for (let i = 0; i < this.options.length; i++) {
          const username = this.options[i].getAttribute('data-username');
          if (username && username.toLowerCase().startsWith(searchBuffer)) {
            this.selectedIndex = i;
            break;
          }
        }
        
        // æ¸…é™¤æœç´¢ç·©è¡
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchBuffer = '';
        }, 1000);
      }
    });
  }
  
  // è¡¨æ ¼è¡Œæ‡¸åœé¡¯ç¤ºå®Œæ•´ä¿¡æ¯
  const descriptionCells = document.querySelectorAll('.description-text');
  descriptionCells.forEach(cell => {
    if (cell.scrollWidth > cell.clientWidth) {
      cell.style.cursor = 'help';
    }
  });
  
  // ç”¨æˆ¶åæ‡¸åœæç¤º
  const userNames = document.querySelectorAll('.user-name');
  userNames.forEach(name => {
    if (name.scrollWidth > name.clientWidth) {
      name.style.cursor = 'help';
    }
  });
});
</script>
{% endblock %}
