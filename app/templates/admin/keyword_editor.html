<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>編輯關鍵字 - {{ keyword.title }}</title>
  
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/keyword-editor.css') }}">
</head>
<body>
<a href="#main-content" class="skip-to-content">跳至主要內容</a>
<div class="keyword-editor-container">
  
  <div class="editor-topbar" role="banner">
    <div class="topbar-left">
      <button type="button" class="btn-toggle-sidebar" onclick="toggleSidebar()" aria-label="開啟選單">
        <i class="bi bi-list"></i>
      </button>
      <a href="{{ url_for('admin.content_manager') }}" class="btn-back">
        <i class="bi bi-arrow-left"></i>
      </a>
      <div class="editor-title-info">
        <h1 class="editor-title">
          {% if is_creating %}
            新增關鍵字
          {% else %}
            {{ keyword.title }}
          {% endif %}
        </h1>
        {% if not is_creating %}
        <div class="editor-meta">
          <span class="meta-item">
            <i class="bi bi-folder"></i>
            {{ keyword.category.name if keyword.category else '未分類' }}
          </span>
          <span class="meta-item">
            <i class="bi bi-eye"></i>
            {{ keyword.view_count or 0 }} 次瀏覽
          </span>
        </div>
        {% endif %}
      </div>
    </div>
    <div class="topbar-right">
      {% if not is_creating %}
      <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('main.keyword_detail', category_slug=keyword.category.slug, slug=keyword.slug) }}'">
        <i class="bi bi-box-arrow-up-right me-1"></i>預覽
      </button>
      {% endif %}
      <button type="button" class="btn btn-primary" onclick="saveKeyword()">
        <i class="bi bi-check-lg me-1"></i>{{ '建立' if is_creating else '儲存' }}
      </button>
    </div>
  </div>

  
  <div class="editor-main">
    
    <div class="sidebar-overlay" onclick="toggleSidebar()" aria-hidden="true"></div>
    
    <div class="editor-sidebar" role="navigation" aria-label="編輯器導航">
      <nav class="editor-nav">
        <a href="#section-basic" class="editor-nav-item active" data-section="basic">
          <i class="bi bi-file-text"></i>
          <span>基本資訊</span>
          <span class="nav-required-badge" title="此分頁含必填欄位" style="display: none;">
            <i class="bi bi-exclamation-circle-fill"></i>
          </span>
        </a>
        <a href="#section-content" class="editor-nav-item" data-section="content">
          <i class="bi bi-card-text"></i>
          <span>內容描述</span>
          <span class="nav-required-badge" title="此分頁含必填欄位" style="display: none;">
            <i class="bi bi-exclamation-circle-fill"></i>
          </span>
        </a>
        <a href="#section-videos" class="editor-nav-item" data-section="videos">
          <i class="bi bi-play-circle"></i>
          <span>影片資源</span>
          <span class="nav-badge">{{ keyword.videos|length }}</span>
        </a>
        <a href="#section-aliases" class="editor-nav-item" data-section="aliases">
          <i class="bi bi-tags"></i>
          <span>別名標籤</span>
          <span class="nav-badge">{{ keyword.aliases|length }}</span>
        </a>
        <a href="#section-seo" class="editor-nav-item" data-section="seo">
          <i class="bi bi-search"></i>
          <span>SEO 優化</span>
        </a>
        <a href="#section-visibility" class="editor-nav-item" data-section="visibility">
          <i class="bi bi-eye"></i>
          <span>顯示設定</span>
        </a>
      </nav>
    </div>

    
    <div class="editor-content" id="main-content" role="main">
        
        {# 必填欄位提示 #}
        <div class="alert alert-warning alert-dismissible fade show m-3" role="alert" id="required-fields-alert" style="display: none;">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>請填寫必要欄位:</strong>
          <div id="required-fields-list" style="margin-top: 8px; font-size: 0.95em;"></div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        {# 如果是從目標清單來的,顯示提示 #}
        {% if goal_item %}
        <div class="alert alert-info alert-dismissible fade show m-3" role="alert">
          <i class="bi bi-list-check me-2"></i>
          <strong>從目標清單創建:</strong> 此關鍵字來自目標清單「{{ goal_item.goal_list.name }}」。
          完成創建後將自動標記為已完成並返回清單頁面。
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}      <form id="keywordForm" method="POST" action="{% if is_creating %}{{ url_for('admin.store_keyword') }}{% else %}{{ url_for('admin.save_keyword_editor', keyword_id=keyword.id) }}{% endif %}">
        {{ form.hidden_tag() }}
        
        {# 如果是從目標清單來的,保存目標項目 ID #}
        {% if goal_item %}
        <input type="hidden" name="from_goal_item" value="{{ goal_item.id }}">
        {% endif %}
        
        
        <div id="section-basic" class="editor-section active">
          <div class="section-header">
            <h2 class="section-title">基本資訊</h2>
            <p class="section-description">設定關鍵字的標題和分類</p>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label for="title" class="form-label">
                標題
                <span class="text-danger fw-bold" title="必填欄位">*</span>
                <span class="ms-2 badge bg-danger-light text-danger">必填</span>
              </label>
              {{ form.title(class="form-control form-control-lg required-field", id="title", placeholder="輸入關鍵字標題", data_required="title") }}
              <small class="form-text text-muted d-block mt-1">
                <i class="bi bi-info-circle me-1"></i>
                不能為空,且需要至少1個字符
              </small>
              {% if form.title.errors %}
                <div class="invalid-feedback d-block mt-2">
                  <i class="bi bi-exclamation-circle me-1"></i>
                  {{ form.title.errors[0] }}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="category_id" class="form-label">
                分類
                <span class="text-danger fw-bold" title="必填欄位">*</span>
                <span class="ms-2 badge bg-danger-light text-danger">必填</span>
              </label>
              {{ form.category_id(class="form-select form-select-lg required-field", id="category_id", data_required="category") }}
              <small class="form-text text-muted d-block mt-1">
                <i class="bi bi-info-circle me-1"></i>
                請選擇關鍵字所屬分類
              </small>
              {% if form.category_id.errors %}
                <div class="invalid-feedback d-block mt-2">
                  <i class="bi bi-exclamation-circle me-1"></i>
                  {{ form.category_id.errors[0] }}
                </div>
              {% endif %}
            </div>

          </div>
        </div>

        
        <div id="section-content" class="editor-section">
          <div class="section-header">
            <h2 class="section-title">
              內容描述
              <span class="text-danger fw-bold" title="必填欄位">*</span>
            </h2>
            <p class="section-description">使用 Markdown 格式撰寫詳細說明 - <span class="text-danger">必填</span></p>
            <div class="section-header-actions">
              <div class="btn-group btn-group-sm" role="group">
                <input type="radio" class="btn-check" name="markdown-mode" id="mode-edit" checked autocomplete="off">
                <label class="btn btn-outline-primary" for="mode-edit">
                  <i class="bi bi-pencil-square"></i> 編輯
                </label>
                
                <input type="radio" class="btn-check" name="markdown-mode" id="mode-split" autocomplete="off">
                <label class="btn btn-outline-primary" for="mode-split">
                  <i class="bi bi-layout-split"></i> 分割
                </label>
                
                <input type="radio" class="btn-check" name="markdown-mode" id="mode-preview" autocomplete="off">
                <label class="btn btn-outline-primary" for="mode-preview">
                  <i class="bi bi-eye"></i> 預覽
                </label>
              </div>
            </div>
          </div>
          <div class="section-body">
            
            <div class="markdown-toolbar mb-3">
              <div class="toolbar-group">
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('# ', '')" title="標題 1">
                  <i class="bi bi-type-h1"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('## ', '')" title="標題 2">
                  <i class="bi bi-type-h2"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('### ', '')" title="標題 3">
                  <i class="bi bi-type-h3"></i>
                </button>
              </div>
              <div class="toolbar-divider"></div>
              <div class="toolbar-group">
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('**', '**')" title="粗體">
                  <i class="bi bi-type-bold"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('*', '*')" title="斜體">
                  <i class="bi bi-type-italic"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('~~', '~~')" title="刪除線">
                  <i class="bi bi-type-strikethrough"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('`', '`')" title="行內程式碼">
                  <i class="bi bi-code"></i>
                </button>
              </div>
              <div class="toolbar-divider"></div>
              <div class="toolbar-group">
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('[', '](url)')" title="連結">
                  <i class="bi bi-link-45deg"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('![', '](url)')" title="圖片">
                  <i class="bi bi-image"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('> ', '')" title="引用">
                  <i class="bi bi-quote"></i>
                </button>
              </div>
              <div class="toolbar-divider"></div>
              <div class="toolbar-group">
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('- ', '')" title="無序列表">
                  <i class="bi bi-list-ul"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('1. ', '')" title="有序列表">
                  <i class="bi bi-list-ol"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('- [ ] ', '')" title="待辦事項">
                  <i class="bi bi-check-square"></i>
                </button>
              </div>
              <div class="toolbar-divider"></div>
              <div class="toolbar-group">
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('```\n', '\n```')" title="程式碼區塊">
                  <i class="bi bi-code-square"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertMarkdown('---\n', '')" title="分隔線">
                  <i class="bi bi-dash-lg"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="insertTable()" title="表格">
                  <i class="bi bi-table"></i>
                </button>
              </div>
              <div class="toolbar-divider"></div>
              <!-- AI 生成按鈕 -->
              <div class="toolbar-group">
                <button type="button" class="btn btn-sm btn-outline-primary ai-generate-btn" id="ai-generate-btn" onclick="generateWithAI()" title="使用 AI 生成描述">
                  <i class="bi bi-robot me-1"></i>AI 生成
                </button>
              </div>
            </div>

            
            <div class="markdown-editor-container has-required-field" id="markdown-container">
              <div class="markdown-editor-pane">
                {{ form.description_markdown(class="form-control markdown-textarea required-field", id="description_markdown", placeholder="# 開始編寫內容\n\n支援完整 Markdown 語法...", data_required="content") }}
              </div>
              <div class="markdown-preview-pane" id="markdown-preview">
                <div class="preview-content"></div>
              </div>
            </div>
            {% if form.description_markdown.errors %}
              <div class="invalid-feedback d-block mt-2">
                <i class="bi bi-exclamation-circle me-1"></i>
                {{ form.description_markdown.errors[0] }}
              </div>
            {% endif %}

            <small class="form-text text-muted d-block mt-2">
              <i class="bi bi-info-circle me-1"></i>
              請輸入內容說明
            </small>

            
            <div class="markdown-stats mt-2">
              <small class="text-muted">
                <span id="char-count">0</span> 字元 · 
                <span id="word-count">0</span> 字 · 
                <span id="line-count">0</span> 行
              </small>
            </div>
          </div>
        </div>

        
        <div id="section-videos" class="editor-section">
          <div class="section-header">
            <h2 class="section-title">影片資源</h2>
            <p class="section-description">新增相關的 YouTube 教學影片</p>
          </div>
          <div class="section-body">
            <div id="videos-container">
              {% for video_form in form.videos %}
              <div class="video-entry card mb-3">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <h5 class="card-title mb-0">影片 #{{ loop.index }}</h5>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVideoEntry(this)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">YouTube 網址</label>
                      {{ video_form.url(class="form-control", placeholder="https://www.youtube.com/watch?v=...") }}
                      {% if video_form.url.errors %}
                        <div class="invalid-feedback d-block">{{ video_form.url.errors[0] }}</div>
                      {% endif %}
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">影片標題</label>
                      {{ video_form.title(class="form-control", placeholder="影片標題") }}
                      {% if video_form.title.errors %}
                        <div class="invalid-feedback d-block">{{ video_form.title.errors[0] }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-primary w-100" onclick="addVideoEntry()">
              <i class="bi bi-plus-circle me-2"></i>新增影片
            </button>
          </div>
        </div>

        
        <div id="section-aliases" class="editor-section">
          <div class="section-header">
            <h2 class="section-title">別名標籤</h2>
            <p class="section-description">新增同義詞或相關術語以提升搜尋效果</p>
          </div>
          <div class="section-body">
            <div id="aliases-container">
              {% for alias_form in form.aliases %}
              <div class="alias-entry mb-2">
                {{ alias_form.alias_id() }}
                <div class="input-group">
                  {{ alias_form.title(class="form-control", placeholder="輸入別名") }}
                  <button type="button" class="btn btn-outline-danger" onclick="removeAliasEntry(this)">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
                {% if alias_form.title.errors %}
                  <div class="invalid-feedback d-block">{{ alias_form.title.errors[0] }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-primary w-100" onclick="addAliasEntry()">
              <i class="bi bi-plus-circle me-2"></i>新增別名
            </button>
          </div>
        </div>

        
        <div id="section-seo" class="editor-section">
          <div class="section-header">
            <h2 class="section-title">SEO 優化</h2>
            <p class="section-description">搜尋引擎優化內容設定</p>
          </div>
          <div class="section-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              SEO 內容將顯示在頁面底部,幫助搜尋引擎理解關鍵字內容
            </div>
            
            <div class="form-check form-switch mb-3">
              {{ form.seo_auto_generate(class="form-check-input", id="seo_auto_generate") }}
              <label class="form-check-label" for="seo_auto_generate">
                自動生成 SEO 內容
              </label>
            </div>

            <div id="manual-seo-content" {% if keyword.seo_auto_generate %}style="display:none"{% endif %}>
              <div class="form-group">
                <label for="seo_content" class="form-label">自訂 SEO 內容 (HTML)</label>
                {{ form.seo_content(class="form-control", id="seo_content", rows="8") }}
                <small class="form-text text-muted">支援 HTML 標籤</small>
                {% if form.seo_content.errors %}
                  <div class="invalid-feedback d-block">{{ form.seo_content.errors[0] }}</div>
                {% endif %}
              </div>
            </div>

            <button type="button" class="btn btn-outline-success mt-3" onclick="regenerateSEO()">
              <i class="bi bi-arrow-clockwise me-2"></i>重新生成 SEO 內容
            </button>
          </div>
        </div>

        
        <div id="section-visibility" class="editor-section">
          <div class="section-header">
            <h2 class="section-title">顯示設定</h2>
            <p class="section-description">控制關鍵字在網站上的顯示狀態</p>
          </div>
          <div class="section-body">
            <div class="form-check form-switch">
              {{ form.is_public(class="form-check-input", id="is_public") }}
              <label class="form-check-label" for="is_public">
                <strong>公開顯示</strong>
              </label>
            </div>
            <p class="text-muted mt-2 mb-0">關閉後,此關鍵字將不會在前台顯示</p>

            {% if not is_creating %}
            <hr class="my-4">

            <div class="metadata-info">
              <h5 class="mb-3">內容資訊</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="info-item">
                    <i class="bi bi-person text-muted me-2"></i>
                    <span class="text-muted">建立者:</span>
                    <strong class="ms-2">{{ keyword.get_author_display_name() }}</strong>
                    {% if current_user.is_admin() %}
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="showEditAuthorModal()">
                      <i class="bi bi-pencil"></i> 編輯
                    </button>
                    {% endif %}
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="info-item">
                    <i class="bi bi-calendar text-muted me-2"></i>
                    <span class="text-muted">建立時間:</span>
                    <strong class="ms-2">{{ keyword.created_at.strftime('%Y-%m-%d') }}</strong>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="info-item">
                    <i class="bi bi-clock text-muted me-2"></i>
                    <span class="text-muted">最後更新:</span>
                    <strong class="ms-2">{{ keyword.updated_at.strftime('%Y-%m-%d %H:%M') if keyword.updated_at else '未更新' }}</strong>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="info-item">
                    <i class="bi bi-eye text-muted me-2"></i>
                    <span class="text-muted">瀏覽次數:</span>
                    <strong class="ms-2">{{ keyword.view_count or 0 }}</strong>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 編輯作者 Modal (僅管理員可用) -->
{% if current_user.is_admin() and not is_creating %}
<div class="modal fade" id="editAuthorModal" tabindex="-1" aria-labelledby="editAuthorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAuthorModalLabel">
          <i class="bi bi-person-badge me-2"></i>編輯關鍵字作者
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">作者類型</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="author_type" id="author_type_user" value="user" checked>
            <label class="btn btn-outline-primary" for="author_type_user">
              <i class="bi bi-person-circle me-1"></i>選擇成員
            </label>
            
            <input type="radio" class="btn-check" name="author_type" id="author_type_text" value="text">
            <label class="btn btn-outline-primary" for="author_type_text">
              <i class="bi bi-pencil me-1"></i>自訂名稱
            </label>
          </div>
        </div>
        
        <div id="author_user_section" class="mb-3">
          <label for="author_user_select" class="form-label">選擇成員</label>
          <select class="form-select" id="author_user_select">
            <option value="">-- 無作者 (將顯示自訂名稱或「未知作者」) --</option>
            {% for user in User.query.order_by(User.username).all() %}
            <option value="{{ user.id }}" {% if keyword.author_id == user.id %}selected{% endif %}>
              {{ user.username }}
              {% if user.id == current_user.id %}(您){% endif %}
              {% if user.role.value == 'admin' %}[管理員]{% endif %}
            </option>
            {% endfor %}
          </select>
        </div>
        
        <div id="author_text_section" class="mb-3" style="display: none;">
          <label for="author_text_input" class="form-label">自訂作者名稱</label>
          <input type="text" class="form-control" id="author_text_input" 
                 placeholder="輸入作者名稱..." 
                 value="{{ keyword.author_name or '' }}">
          <small class="text-muted">設定後將優先顯示此名稱，即使有關聯的成員帳號</small>
        </div>
        
        <div class="alert alert-info mb-0">
          <small>
            <i class="bi bi-info-circle me-1"></i>
            <strong>說明:</strong>
            <ul class="mb-0 mt-1">
              <li>選擇成員:將關鍵字作者設為系統內的成員帳號</li>
              <li>自訂名稱:設定文字作者名稱,適用於已離開成員或外部作者</li>
              <li>若同時設定兩者,將優先顯示自訂名稱</li>
            </ul>
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveAuthorChange()">
          <i class="bi bi-check-circle me-1"></i>儲存變更
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<!-- DOMPurify 庫,用於防止 XSS 攻擊 -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<script src="{{ url_for('static', filename='js/keyword-editor.js') }}"></script>
<script>
  // AI 功能狀態
  let aiEnabled = false;
  
  // 檢查 AI 功能狀態
  async function checkAIStatus() {
    try {
      const response = await fetch('{{ url_for("admin.ai_status") }}');
      const data = await response.json();
      aiEnabled = data.enabled;
      
      updateAIGenerateButton();
    } catch (error) {
      console.error('Failed to check AI status:', error);
    }
  }
  
  // 更新 AI 生成按鈕狀態
  function updateAIGenerateButton() {
    const aiBtn = document.getElementById('ai-generate-btn');
    const titleInput = document.getElementById('title');
    
    if (!aiBtn) return;
    
    const titleFilled = titleInput && titleInput.value.trim();
    
    if (aiEnabled && titleFilled) {
      aiBtn.classList.remove('disabled');
      aiBtn.title = '使用 AI 生成描述';
    } else if (!aiEnabled) {
      aiBtn.classList.add('disabled');
      aiBtn.title = 'AI 功能未啟用，請聯繫管理員';
    } else {
      aiBtn.classList.add('disabled');
      aiBtn.title = '請先填寫關鍵字標題';
    }
  }
  
  // AI 生成描述
  async function generateWithAI() {
    const titleInput = document.getElementById('title');
    const textarea = document.getElementById('description_markdown');
    const aiBtn = document.getElementById('ai-generate-btn');
    
    if (!titleInput || !textarea) {
      showNotification('找不到編輯器元素', 'error');
      return;
    }
    
    const keywordTitle = titleInput.value.trim();
    
    if (!keywordTitle) {
      showNotification('請先填寫關鍵字標題', 'warning');
      // 導航到基本資訊分頁並聚焦標題欄位
      navigateToSection('basic');
      setTimeout(() => {
        titleInput.focus();
        titleInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
      return;
    }
    
    // 確認是否要覆蓋現有內容
    if (textarea.value.trim()) {
      if (!confirm('目前已有內容，AI 生成的內容將會覆蓋現有內容。確定要繼續嗎？')) {
        return;
      }
    }
    
    // 顯示載入狀態
    const originalHtml = aiBtn.innerHTML;
    aiBtn.disabled = true;
    aiBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>生成中...';
    
    try {
      // Get CSRF token
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      
      const headers = {
          'Content-Type': 'application/json',
      };
      
      if (csrfToken) {
          headers['X-CSRFToken'] = csrfToken;
      }

      const response = await fetch('{{ url_for("admin.generate_ai_description") }}', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ keyword_title: keywordTitle })
      });
      
      const data = await response.json();
      
      if (data.success) {
        // 填入生成的內容
        textarea.value = data.content;
        textarea.dispatchEvent(new Event('input'));
        
        // 顯示成功訊息
        let message = 'AI 已生成描述內容';
        if (data.usage && data.usage.total_tokens) {
          message += ` (使用 ${data.usage.total_tokens} tokens)`;
        }
        showNotification(message, 'success');
        
        // 標記表單已變更
        formChanged = true;
        
        // 更新統計
        if (typeof updateStats === 'function') {
          updateStats();
        }
      } else {
        showNotification(data.message || 'AI 生成失敗', 'error');
      }
    } catch (error) {
      console.error('AI generation error:', error);
      showNotification('AI 生成時發生錯誤: ' + error.message, 'error');
    } finally {
      // 恢復按鈕狀態
      aiBtn.disabled = false;
      aiBtn.innerHTML = originalHtml;
    }
  }
  
  // 初始化編輯器
  document.addEventListener('DOMContentLoaded', function() {
    initKeywordEditor();
    
    // 檢查 AI 功能狀態
    checkAIStatus();
    
    // 監聽標題輸入以更新 AI 按鈕狀態
    const titleInput = document.getElementById('title');
    if (titleInput) {
      titleInput.addEventListener('input', updateAIGenerateButton);
    }
    
    // SEO 自動生成切換
    const seoAutoGenerate = document.getElementById('seo_auto_generate');
    if (seoAutoGenerate) {
      seoAutoGenerate.addEventListener('change', function() {
        const manualContent = document.getElementById('manual-seo-content');
        if (manualContent) {
          manualContent.style.display = this.checked ? 'none' : 'block';
        }
      });
    }
    
    // 作者類型切換
    const authorTypeRadios = document.querySelectorAll('input[name="author_type"]');
    authorTypeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        const userSection = document.getElementById('author_user_section');
        const textSection = document.getElementById('author_text_section');
        
        if (this.value === 'user') {
          userSection.style.display = 'block';
          textSection.style.display = 'none';
        } else {
          userSection.style.display = 'none';
          textSection.style.display = 'block';
        }
      });
    });
  });
  
  {% if current_user.is_admin() and not is_creating %}
  let editAuthorModal;
  
  function showEditAuthorModal() {
    if (!editAuthorModal) {
      editAuthorModal = new bootstrap.Modal(document.getElementById('editAuthorModal'));
    }
    
    // 根據當前狀態設定預設選項
    const hasAuthorId = {{ 'true' if keyword.author_id else 'false' }};
    const hasAuthorName = {{ 'true' if keyword.author_name else 'false' }};
    
    if (hasAuthorName) {
      document.getElementById('author_type_text').checked = true;
      document.getElementById('author_user_section').style.display = 'none';
      document.getElementById('author_text_section').style.display = 'block';
    } else {
      document.getElementById('author_type_user').checked = true;
      document.getElementById('author_user_section').style.display = 'block';
      document.getElementById('author_text_section').style.display = 'none';
    }
    
    editAuthorModal.show();
  }
  
  async function saveAuthorChange() {
    const authorType = document.querySelector('input[name="author_type"]:checked').value;
    const authorUserId = document.getElementById('author_user_select').value;
    const authorTextName = document.getElementById('author_text_input').value.trim();
    
    // 獲取 CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    
    const data = {
      author_type: authorType,
      author_id: authorType === 'user' ? (authorUserId || null) : null,
      author_name: authorType === 'text' ? authorTextName : '',
      csrf_token: csrfToken
    };
    
    try {
      const response = await fetch('{{ url_for("admin.update_keyword_author", keyword_id=keyword.id) }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(result.message);
        location.reload();
      } else {
        alert(result.message || '更新失敗');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('更新時發生錯誤');
    }
  }
  {% endif %}
</script>
</body>
</html>
