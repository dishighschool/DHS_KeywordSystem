{% extends "admin/base.html" %}
{% block title %}{{ '編輯' if keyword else '新增' }}關鍵字{% endblock %}

{% block content %}
<section class="py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold mb-0">{{ '編輯' if keyword else '新增' }}關鍵字</h1>
    <a class="btn btn-outline-secondary" href="{{ url_for('admin.manage_keywords') }}">返回列表</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" id="keywordForm">
        {{ form.hidden_tag() }}
        <div class="mb-3">
          {{ form.title.label(class_='form-label') }}
          {{ form.title(class_='form-control', placeholder='輸入關鍵字標題') }}
          {% for error in form.title.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
        </div>
        <div class="mb-3">
          {{ form.category_id.label(class_='form-label') }}
          {{ form.category_id(class_='form-select') }}
          {% for error in form.category_id.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
        </div>
        <div class="mb-4">
          <label for="markdown-editor" class="form-label">{{ form.description_markdown.label.text }}</label>
          <textarea class="form-control" id="markdown-editor" name="description_markdown" rows="10" placeholder="使用 Markdown 撰寫內容">{{ form.description_markdown.data or '' }}</textarea>
          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            支援 Markdown 語法:標題、粗體、斜體、清單、連結、圖片、程式碼區塊等
          </div>
          {% for error in form.description_markdown.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
        </div>
        
        <div class="mb-4">
          <div class="form-check form-switch">
            {{ form.is_public(class_='form-check-input', role='switch', style='width: 3em; height: 1.5em;') }}
            {{ form.is_public.label(class_='form-label fw-semibold ms-2') }}
          </div>
          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>隱藏的關鍵字不會顯示在前台,但後台仍可管理
          </div>
        </div>

        <div class="mb-4 border-top pt-4">
          <h5 class="mb-3 fw-semibold">
            <i class="bi bi-search me-2"></i>SEO 搜尋優化設定
          </h5>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              {{ form.seo_auto_generate(class_='form-check-input', role='switch', style='width: 3em; height: 1.5em;', id='seoAutoGenerateSwitch') }}
              {{ form.seo_auto_generate.label(class_='form-label fw-semibold ms-2') }}
            </div>
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>自動生成常見問題與注音輸入法常見錯誤,提升搜尋引擎可見度
            </div>
          </div>

          {% if keyword %}
          <div class="mt-3 mb-3">
            {{ form.regenerate_seo(class_='btn btn-outline-primary') }}
            <span class="form-text d-inline-block ms-2">
              <i class="bi bi-arrow-clockwise me-1"></i>重新生成 SEO 內容(會覆蓋現有內容)
            </span>
          </div>
          {% endif %}

          <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label fw-semibold mb-0">
                <i class="bi bi-code-square me-1"></i>SEO 內容編輯
              </label>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleSeoPreview()">
                <i class="bi bi-eye me-1"></i><span id="previewToggleText">預覽</span>
              </button>
            </div>
            
            
            <div id="seoEditorSection">
              {{ form.seo_content(class_='form-control', id='seo-content-editor', rows='15', placeholder='SEO 內容將在此顯示...\n\n提示:\n- 自動生成模式:內容會自動更新\n- 手動模式:可直接編輯純文字', style='font-size: 14px; line-height: 1.8; white-space: pre-wrap;') }}
              <div class="form-text mt-2">
                <i class="bi bi-info-circle me-1"></i>
                <span id="seoModeHint">
                  {% if form.seo_auto_generate.data %}
                  <strong>自動生成模式:</strong> 可檢視和編輯生成的純文字內容。關閉自動生成開關可保留您的修改。
                  {% else %}
                  <strong>手動編輯模式:</strong> 您的修改會被保存。開啟自動生成開關將在下次瀏覽時覆蓋此內容。
                  {% endif %}
                </span>
              </div>
              {% for error in form.seo_content.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>

            
            <div id="seoPreviewSection" style="display: none;">
              <div class="card shadow-sm">
                <div class="card-header bg-light">
                  <small class="text-muted"><i class="bi bi-eye-fill me-1"></i>前台顯示預覽</small>
                </div>
                <div class="card-body" id="seoPreviewContent" style="max-height: 500px; overflow-y: auto; white-space: pre-line; line-height: 1.8;">
                  
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">關鍵字別名 <span class="text-muted small">(選填)</span></label>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAliasField()">
              <i class="bi bi-plus-lg me-1"></i>新增別名
            </button>
          </div>
          <div class="form-text mb-3">
            別名將產生對應的關鍵字頁面,並與主關鍵字自動互相連結。
          </div>
          <div id="aliasFieldList">
            {% for subform in form.aliases %}
            <div class="card shadow-none border border-200 rounded-3 mb-3 alias-entry" data-alias-index="{{ loop.index0 }}">
              <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-12 col-md-9 col-lg-10">
                    {{ subform.form.id(class_='alias-id-field') }}
                    {{ subform.form.title.label(class_='form-label') }}
                    {{ subform.form.title(class_='form-control alias-title-field', placeholder='輸入別名') }}
                    {% for error in subform.form.title.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                  </div>
                  <div class="col-12 col-md-3 col-lg-2 d-grid d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-outline-danger w-100 mt-2 mt-md-0" onclick="removeAliasField(this)" title="移除此別名">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            {% if not form.aliases.entries %}
            <div id="emptyAliasMessage" class="text-center text-muted py-3 border border-dashed rounded-3">
              <i class="bi bi-collection fs-3 opacity-50 d-block mb-2"></i>
              <p class="mb-0 small">尚未新增任何別名</p>
              <p class="mb-0 small">點擊上方按鈕開始新增</p>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label mb-0">YouTube 影片 <span class="text-muted small">(選填)</span></label>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addVideoField()">
              <i class="bi bi-plus-lg me-1"></i>新增影片欄位
            </button>
          </div>
          <div id="videoFieldList" class="mt-3">
            {% for subform in form.videos %}
            <div class="card shadow-none border border-200 rounded-3 mb-3 video-entry" data-video-index="{{ loop.index0 }}">
              <div class="card-body">
                <div class="d-flex align-items-start">
                  <div class="drag-handle-video me-3 text-muted" title="拖動調整順序" style="cursor: move;">
                    <i class="bi bi-grip-vertical fs-4"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="row g-3">
                      <div class="col-md-5">
                        {{ subform.form.title.label(class_='form-label') }}
                        {{ subform.form.title(class_='form-control', placeholder='影片標題 (選填)') }}
                      </div>
                      <div class="col-md-5">
                        {{ subform.form.url.label(class_='form-label') }}
                        {{ subform.form.url(class_='form-control', placeholder='https://www.youtube.com/...') }}
                      </div>
                      <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger w-100" onclick="removeVideoField(this)" title="移除此影片">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            {% if not form.videos.entries %}
            <div id="emptyVideoMessage" class="text-center text-muted py-3">
              <i class="bi bi-camera-video-off fs-3 opacity-50 d-block mb-2"></i>
              <p class="mb-0 small">尚未新增任何影片</p>
              <p class="mb-0 small">點擊上方按鈕新增影片欄位</p>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
          <a href="{{ url_for('admin.manage_keywords') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>取消
          </a>
          <button class="btn btn-primary px-5" type="submit">
            <i class="bi bi-check-lg me-1"></i>{{ '更新關鍵字' if keyword else '建立關鍵字' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_head %}
{{ super() }}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
{% endblock %}

{% block extra_scripts %}
{{ super() }}

<script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
/* EasyMDE 編輯器自訂樣式 */
.EasyMDEContainer {
  border-radius: 8px;
  overflow: hidden;
}

.EasyMDEContainer .CodeMirror {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.6;
}

.EasyMDEContainer .editor-toolbar {
  border: 1px solid #dee2e6;
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  background: linear-gradient(to bottom, #ffffff, #f8f9fa);
  padding: 8px 10px;
}

.EasyMDEContainer .editor-toolbar button {
  color: #495057;
  border-radius: 4px;
  transition: all 0.2s;
  padding: 6px 10px;
  margin: 2px;
}

.EasyMDEContainer .editor-toolbar button:hover,
.EasyMDEContainer .editor-toolbar button.active {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

.EasyMDEContainer .editor-toolbar button.fa-table {
  font-weight: bold;
  border: 2px solid #dee2e6;
}

.EasyMDEContainer .editor-toolbar button.fa-table:hover {
  border-color: #667eea;
  background: #667eea;
}

.EasyMDEContainer .editor-toolbar i.separator {
  border-left: 1px solid #dee2e6;
  border-right: none;
}

.EasyMDEContainer .editor-preview-side,
.EasyMDEContainer .editor-preview {
  border: 1px solid #dee2e6;
  background: #ffffff;
  padding: 20px;
  font-family: 'Noto Sans TC', sans-serif;
}

.EasyMDEContainer .editor-preview-side h1,
.EasyMDEContainer .editor-preview h1,
.EasyMDEContainer .editor-preview-side h2,
.EasyMDEContainer .editor-preview h2,
.EasyMDEContainer .editor-preview-side h3,
.EasyMDEContainer .editor-preview h3 {
  color: #667eea;
  font-weight: 600;
}

.EasyMDEContainer .editor-statusbar {
  border: 1px solid #dee2e6;
  border-top: none;
  border-radius: 0 0 8px 8px;
  background: #f8f9fa;
  color: #6c757d;
  font-size: 12px;
  padding: 8px 10px;
}

.EasyMDEContainer .CodeMirror-cursor {
  border-left-color: #667eea;
}

.EasyMDEContainer .CodeMirror-selected {
  background: rgba(102, 126, 234, 0.1);
}

/* 並排模式調整 */
.editor-preview-side {
  position: absolute !important;
  width: 50% !important;
  top: 50px !important;
  right: 0 !important;
  bottom: 0 !important;
  height: auto !important;
  border-left: 1px solid #dee2e6 !important;
}

.CodeMirror-sided {
  width: 50% !important;
}

/* 影片欄位拖動樣式 */
.sortable-ghost {
  opacity: 0.4;
  background: #f8f9fa;
}

.drag-handle-video {
  cursor: move;
  opacity: 0.6;
  transition: opacity 0.2s;
}

.drag-handle-video:hover {
  opacity: 1;
}

.video-entry {
  transition: all 0.2s ease;
}

.video-entry.sortable-ghost {
  opacity: 0.5;
  transform: scale(0.98);
}

.border-dashed {
  border-style: dashed !important;
}

.alias-entry {
  transition: all 0.2s ease;
}

.alias-entry.removing {
  opacity: 0;
  transform: translateX(-8px);
}

.alias-entry.adding {
  opacity: 0;
}

/* SEO 編輯器樣式 */
#seo-content-editor {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  transition: all 0.3s;
  font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
}

#seo-content-editor:focus {
  background: #ffffff;
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
}

#seoPreviewSection .card {
  border: 2px solid #e3e6f0;
}

#seoPreviewContent {
  background: #ffffff;
  font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
}
</style>
<script>
let videoFieldCount = {{ form.videos.entries|length }};
let easyMDE = null;

// 初始化 Markdown 編輯器和拖動排序
document.addEventListener('DOMContentLoaded', function() {
  console.log('頁面已載入,開始初始化...');
  
  // 初始化 EasyMDE Markdown 編輯器
  const markdownTextarea = document.getElementById('markdown-editor');
  if (markdownTextarea) {
    console.log('找到 Markdown 編輯器元素');
    try {
      easyMDE = new EasyMDE({
        element: markdownTextarea,
        spellChecker: false,
        placeholder: '使用 Markdown 語法撰寫內容...',
        status: ['lines', 'words', 'cursor'],
        toolbar: [
        {
          name: 'bold',
          action: EasyMDE.toggleBold,
          className: 'fa fa-bold',
          title: '粗體 (Ctrl/Cmd+B)',
        },
        {
          name: 'italic',
          action: EasyMDE.toggleItalic,
          className: 'fa fa-italic',
          title: '斜體 (Ctrl/Cmd+I)',
        },
        {
          name: 'heading',
          action: EasyMDE.toggleHeadingSmaller,
          className: 'fa fa-header',
          title: '標題',
        },
        '|',
        {
          name: 'quote',
          action: EasyMDE.toggleBlockquote,
          className: 'fa fa-quote-left',
          title: '引用',
        },
        {
          name: 'unordered-list',
          action: EasyMDE.toggleUnorderedList,
          className: 'fa fa-list-ul',
          title: '無序清單',
        },
        {
          name: 'ordered-list',
          action: EasyMDE.toggleOrderedList,
          className: 'fa fa-list-ol',
          title: '有序清單',
        },
        '|',
        {
          name: 'link',
          action: EasyMDE.drawLink,
          className: 'fa fa-link',
          title: '插入連結 (Ctrl/Cmd+K)',
        },
        {
          name: 'image',
          action: EasyMDE.drawImage,
          className: 'fa fa-picture-o',
          title: '插入圖片',
        },
        '|',
        {
          name: 'code',
          action: EasyMDE.toggleCodeBlock,
          className: 'fa fa-code',
          title: '程式碼區塊',
        },
        {
          name: 'table',
          action: EasyMDE.drawTable,
          className: 'fa fa-table',
          title: '插入表格',
        },
        '|',
        {
          name: 'preview',
          action: EasyMDE.togglePreview,
          className: 'fa fa-eye no-disable',
          title: '切換預覽 (Ctrl/Cmd+P)',
        },
        {
          name: 'side-by-side',
          action: EasyMDE.toggleSideBySide,
          className: 'fa fa-columns no-disable no-mobile',
          title: '並排預覽',
        },
        '|',
        {
          name: 'guide',
          action: 'https://www.markdownguide.org/basic-syntax/',
          className: 'fa fa-question-circle',
          title: 'Markdown 語法指南',
        }
      ],
      renderingConfig: {
        codeSyntaxHighlighting: true,
      },
      insertTexts: {
        link: ['[', '](https://)'],
        image: ['![', '](https://)'],
        table: ['', '\n\n| 欄位 1 | 欄位 2 | 欄位 3 |\n| ------ | ------ | ------ |\n| 文字   | 文字   | 文字   |\n\n'],
      },
      previewRender: function(plainText, preview) {
        // 使用後端 API 進行 markdown 渲染，確保與前端顯示完全一致
        // 包含 unescape 處理和完整的 tables、code blocks 等支援
        
        const previewElement = preview;
        
        // 非同步呼叫後端 API 更新預覽
        if (previewElement && plainText) {
          const csrfToken = document.querySelector('input[name="csrf_token"]');
          const headers = {
            'Content-Type': 'application/json'
          };
          
          // 如果有 CSRF token 就加上
          if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken.value;
          }
          
          fetch('{{ url_for("admin.markdown_preview") }}', {
            method: 'POST',
            headers: headers,
            credentials: 'same-origin',
            body: JSON.stringify({ markdown: plainText })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('HTTP ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            if (data.success && data.html) {
              previewElement.innerHTML = data.html;
            } else if (data.error) {
              console.error('Markdown preview API error:', data.error);
              // 如果 API 失敗，回退到內建渲染
              previewElement.innerHTML = this.parent.markdown(plainText);
            }
          })
          .catch(error => {
            console.error('Markdown preview fetch error:', error);
            // 如果請求失敗，使用內建渲染器
            previewElement.innerHTML = this.parent.markdown(plainText);
          });
        }
        
        // 立即返回內建處理結果（EasyMDE 的預設 markdown 渲染）
        // API 請求完成後會用後端的結果覆蓋此內容
        return this.parent.markdown(plainText);
      },
      minHeight: '400px',
      maxHeight: '600px',
      autosave: {
        enabled: false,
      },
      promptURLs: true,
      shortcuts: {
        toggleBold: 'Cmd-B',
        toggleItalic: 'Cmd-I',
        drawLink: 'Cmd-K',
        togglePreview: 'Cmd-P',
      },
    });
    console.log('EasyMDE 編輯器初始化成功');
    } catch (error) {
      console.error('EasyMDE 初始化失敗:', error);
    }
  } else {
    console.error('未找到 markdown-editor 元素');
  }
  
  // 表單提交前同步 EasyMDE 內容
  const keywordForm = document.getElementById('keywordForm');
  if (keywordForm) {
    console.log('找到表單元素,添加提交監聽器');
    keywordForm.addEventListener('submit', function(e) {
      console.log('表單提交事件觸發');
      if (easyMDE) {
        try {
          // 確保 EasyMDE 的內容同步到 textarea
          const value = easyMDE.value();
          const textarea = document.getElementById('markdown-editor');
          if (textarea) {
            textarea.value = value;
            console.log('已同步 Markdown 內容 (長度:', value.length, ')');
            
            // 驗證內容不能為空
            if (!value || value.trim() === '') {
              e.preventDefault();
              alert('請輸入關鍵字內容');
              // 聚焦到 CodeMirror 編輯器
              if (easyMDE.codemirror) {
                easyMDE.codemirror.focus();
              }
              return false;
            }
          }
        } catch (error) {
          console.error('同步內容時發生錯誤:', error);
        }
      }
      // 允許表單正常提交
      return true;
    });
  } else {
    console.error('未找到表單元素');
  }

  // 初始化影片欄位拖動排序
  const videoList = document.getElementById('videoFieldList');
  if (videoList) {
    new Sortable(videoList, {
      animation: 150,
      handle: '.drag-handle-video',
      ghostClass: 'sortable-ghost',
      filter: '#emptyVideoMessage',
      onEnd: function() {
        updateVideoFieldNames();
      }
    });
  }

  updateAliasFieldNames();

  // SEO 自動生成開關控制
  const seoAutoSwitch = document.getElementById('seoAutoGenerateSwitch');
  const seoModeHint = document.getElementById('seoModeHint');
  
  if (seoAutoSwitch && seoModeHint) {
    // 更新提示文字
    function updateSeoModeHint() {
      if (seoAutoSwitch.checked) {
        seoModeHint.innerHTML = '<strong>自動生成模式:</strong> 可檢視和編輯生成的內容。關閉自動生成開關可保留您的修改。';
      } else {
        seoModeHint.innerHTML = '<strong>手動編輯模式:</strong> 您的修改會被保存。開啟自動生成開關將在下次瀏覽時覆蓋此內容。';
      }
    }
    
    seoAutoSwitch.addEventListener('change', updateSeoModeHint);
  }
});

// SEO 預覽切換
function toggleSeoPreview() {
  const editorSection = document.getElementById('seoEditorSection');
  const previewSection = document.getElementById('seoPreviewSection');
  const previewContent = document.getElementById('seoPreviewContent');
  const toggleText = document.getElementById('previewToggleText');
  const seoEditor = document.getElementById('seo-content-editor');
  
  if (previewSection.style.display === 'none') {
    // 切換到預覽模式 - 純文字顯示
    const textContent = seoEditor.value;
    if (textContent && textContent.trim()) {
      previewContent.textContent = textContent;  // 使用 textContent 而非 innerHTML
    } else {
      previewContent.innerHTML = '<p class="text-muted text-center py-4"><i class="bi bi-inbox me-2"></i>尚無 SEO 內容</p>';
    }
    editorSection.style.display = 'none';
    previewSection.style.display = 'block';
    toggleText.textContent = '編輯';
  } else {
    // 切換回編輯模式
    editorSection.style.display = 'block';
    previewSection.style.display = 'none';
    toggleText.textContent = '預覽';
  }
}

// 新增影片欄位
function addVideoField() {
  const videoList = document.getElementById('videoFieldList');
  const emptyMessage = document.getElementById('emptyVideoMessage');
  
  // 移除空白訊息
  if (emptyMessage) {
    emptyMessage.remove();
  }
  
  const newIndex = videoFieldCount;
  const videoCard = document.createElement('div');
  videoCard.className = 'card shadow-none border border-200 rounded-3 mb-3 video-entry';
  videoCard.setAttribute('data-video-index', newIndex);
  videoCard.innerHTML = `
    <div class="card-body">
      <div class="d-flex align-items-start">
        <div class="drag-handle-video me-3 text-muted" title="拖動調整順序" style="cursor: move;">
          <i class="bi bi-grip-vertical fs-4"></i>
        </div>
        <div class="flex-grow-1">
          <div class="row g-3">
            <div class="col-md-5">
              <label class="form-label" for="videos-${newIndex}-title">影片標題</label>
              <input class="form-control" id="videos-${newIndex}-title" name="videos-${newIndex}-title" placeholder="影片標題 (選填)" type="text">
            </div>
            <div class="col-md-5">
              <label class="form-label" for="videos-${newIndex}-url">影片連結</label>
              <input class="form-control" id="videos-${newIndex}-url" name="videos-${newIndex}-url" placeholder="https://www.youtube.com/..." type="url">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="button" class="btn btn-outline-danger w-100" onclick="removeVideoField(this)" title="移除此影片">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  videoList.appendChild(videoCard);
  videoFieldCount++;
  
  // 添加淡入動畫
  videoCard.style.opacity = '0';
  setTimeout(() => {
    videoCard.style.transition = 'opacity 0.3s';
    videoCard.style.opacity = '1';
  }, 10);
}

// 移除影片欄位
function removeVideoField(button) {
  const videoCard = button.closest('.video-entry');
  const videoList = document.getElementById('videoFieldList');
  
  // 淡出動畫
  videoCard.style.transition = 'opacity 0.3s';
  videoCard.style.opacity = '0';
  
  setTimeout(() => {
    videoCard.remove();
    updateVideoFieldNames();
    
    // 如果沒有影片了,顯示空白訊息
    const remainingVideos = videoList.querySelectorAll('.video-entry');
    if (remainingVideos.length === 0) {
      videoList.innerHTML = `
        <div id="emptyVideoMessage" class="text-center text-muted py-3">
          <i class="bi bi-camera-video-off fs-3 opacity-50 d-block mb-2"></i>
          <p class="mb-0 small">尚未新增任何影片</p>
          <p class="mb-0 small">點擊上方按鈕新增影片欄位</p>
        </div>
      `;
    }
  }, 300);
}

// 更新所有影片欄位的 name 屬性(確保表單提交時順序正確)
function updateVideoFieldNames() {
  const videoCards = document.querySelectorAll('.video-entry');
  videoCards.forEach((card, index) => {
    card.setAttribute('data-video-index', index);
    
    const titleInput = card.querySelector('input[type="text"]');
    const urlInput = card.querySelector('input[type="url"]');
    const titleLabel = card.querySelector('label[for^="videos-"]');
    const urlLabel = card.querySelectorAll('label[for^="videos-"]')[1];
    
    if (titleInput) {
      titleInput.id = `videos-${index}-title`;
      titleInput.name = `videos-${index}-title`;
    }
    if (urlInput) {
      urlInput.id = `videos-${index}-url`;
      urlInput.name = `videos-${index}-url`;
    }
    if (titleLabel) {
      titleLabel.setAttribute('for', `videos-${index}-title`);
    }
    if (urlLabel) {
      urlLabel.setAttribute('for', `videos-${index}-url`);
    }
  });
}

// 新增別名欄位
function addAliasField() {
  const aliasList = document.getElementById('aliasFieldList');
  const emptyMessage = document.getElementById('emptyAliasMessage');
  if (emptyMessage) {
    emptyMessage.remove();
  }

  const newIndex = aliasList.querySelectorAll('.alias-entry').length;
  const aliasCard = document.createElement('div');
  aliasCard.className = 'card shadow-none border border-200 rounded-3 mb-3 alias-entry adding';
  aliasCard.setAttribute('data-alias-index', newIndex);
  aliasCard.innerHTML = `
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-9 col-lg-10">
          <input type="hidden" class="alias-id-field" name="aliases-${newIndex}-id" id="aliases-${newIndex}-id" value="">
          <label class="form-label" for="aliases-${newIndex}-title">別名</label>
          <input class="form-control alias-title-field" id="aliases-${newIndex}-title" name="aliases-${newIndex}-title" placeholder="輸入別名" type="text">
        </div>
        <div class="col-12 col-md-3 col-lg-2 d-grid d-md-flex justify-content-md-end">
          <button type="button" class="btn btn-outline-danger w-100 mt-2 mt-md-0" onclick="removeAliasField(this)" title="移除此別名">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;

  aliasList.appendChild(aliasCard);
  requestAnimationFrame(() => {
    aliasCard.classList.remove('adding');
    aliasCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    aliasCard.style.opacity = '1';
    aliasCard.style.transform = 'translateY(0)';
  });

  updateAliasFieldNames();
}

// 移除別名欄位
function removeAliasField(button) {
  const aliasCard = button.closest('.alias-entry');
  const aliasList = document.getElementById('aliasFieldList');
  aliasCard.classList.add('removing');

  setTimeout(() => {
    aliasCard.remove();
    updateAliasFieldNames();

    if (aliasList.querySelectorAll('.alias-entry').length === 0) {
      const emptyState = document.createElement('div');
      emptyState.id = 'emptyAliasMessage';
      emptyState.className = 'text-center text-muted py-3 border border-dashed rounded-3';
      emptyState.innerHTML = `
        <i class="bi bi-collection fs-3 opacity-50 d-block mb-2"></i>
        <p class="mb-0 small">尚未新增任何別名</p>
        <p class="mb-0 small">點擊上方按鈕開始新增</p>
      `;
      aliasList.appendChild(emptyState);
    }
  }, 200);
}

// 重新整理別名欄位的 name/id 屬性
function updateAliasFieldNames() {
  const aliasCards = document.querySelectorAll('.alias-entry');
  aliasCards.forEach((card, index) => {
    card.setAttribute('data-alias-index', index);
    const hiddenInput = card.querySelector('.alias-id-field');
    const titleInput = card.querySelector('.alias-title-field');
    const titleLabel = card.querySelector('label');

    if (hiddenInput) {
      hiddenInput.name = `aliases-${index}-id`;
      hiddenInput.id = `aliases-${index}-id`;
    }

    if (titleInput) {
      titleInput.name = `aliases-${index}-title`;
      titleInput.id = `aliases-${index}-title`;
    }

    if (titleLabel && titleInput) {
      titleLabel.setAttribute('for', titleInput.id);
    }
  });
}
</script>
{% endblock %}
