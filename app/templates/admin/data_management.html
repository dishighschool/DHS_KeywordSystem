{% extends "admin/base.html" %}

{% block title %}資料管理 - 匯出/匯入{% endblock %}

{% block header_title %}資料管理{% endblock %}
{% block page_icon_class %}bi bi-database{% endblock %}
{% block page_title %}系統資料管理{% endblock %}
{% block page_subtitle %}匯出或匯入完整系統資料{% endblock %}

{% block content %}
    <!-- 警告提示 -->
    <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>注意:</strong> 匯入資料會影響系統內容，請謹慎操作。建議在匯入前先匯出現有資料作為備份。
    </div>

    <!-- 備份提示 -->
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i>
        <strong>備份提示:</strong> 系統已啟用自動備份功能，每天會自動建立系統資料備份，保留最近 30 天。
        備份列表請向下捲動查看。
    </div>

    <!-- 系統統計 -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 目前系統資料統計</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">成員</h6>
                            <h4 class="mb-0">{{ stats.users }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-success">
                            <i class="bi bi-folder"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">分類</h6>
                            <h4 class="mb-0">{{ stats.categories }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-info">
                            <i class="bi bi-book"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">關鍵字</h6>
                            <h4 class="mb-0">{{ stats.keywords }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-warning">
                            <i class="bi bi-tag"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">別名</h6>
                            <h4 class="mb-0">{{ stats.aliases }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-danger">
                            <i class="bi bi-youtube"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">影片</h6>
                            <h4 class="mb-0">{{ stats.videos }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-secondary">
                            <i class="bi bi-menu-button-wide"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">導航連結</h6>
                            <h4 class="mb-0">{{ stats.nav_links }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-dark">
                            <i class="bi bi-link-45deg"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">底部連結</h6>
                            <h4 class="mb-0">{{ stats.footer_links }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-purple">
                            <i class="bi bi-megaphone"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">公告橫幅</h6>
                            <h4 class="mb-0">{{ stats.announcements }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-teal">
                            <i class="bi bi-gear"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">網站設定</h6>
                            <h4 class="mb-0">{{ stats.site_settings }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-orange">
                            <i class="bi bi-list-check"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">目標清單</h6>
                            <h4 class="mb-0">{{ stats.goal_lists }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-cyan">
                            <i class="bi bi-check2-square"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">目標項目</h6>
                            <h4 class="mb-0">{{ stats.goal_items }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-indigo">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="stat-info">
                            <h6 class="text-muted mb-1">編輯日誌</h6>
                            <h4 class="mb-0">{{ stats.edit_logs }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 匯出資料 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-download"></i> 匯出系統資料</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        匯出所有系統資料為 JSON 格式檔案，包括:
                    </p>
                    <ul class="mb-3">
                        <li>所有用戶資料 (不含敏感資訊)</li>
                        <li>分類與關鍵字</li>
                        <li>別名與影片</li>
                        <li>導航與底部連結</li>
                        <li>公告橫幅</li>
                        <li>網站設定</li>
                        <li>目標清單與項目</li>
                    </ul>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        匯出的檔案可用於備份或遷移到其他系統。
                    </div>
                    <a href="{{ url_for('admin.export_system_data') }}" class="btn btn-success btn-lg w-100">
                        <i class="bi bi-download"></i> 匯出完整系統資料
                    </a>
                </div>
            </div>
        </div>

        <!-- 匯入資料 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-upload"></i> 匯入系統資料</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('admin.import_system_data') }}" method="post" enctype="multipart/form-data" id="importForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="import_file" class="form-label">選擇匯入檔案 (JSON / JSON.GZ)</label>
                            <input type="file" class="form-control" id="import_file" name="import_file" accept=".json,.json.gz,.gz" required>
                            <small class="form-text text-muted">支援 JSON 或壓縮的 JSON.GZ 格式</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">匯入模式</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="import_mode" id="mode_merge" value="merge" checked>
                                <label class="form-check-label" for="mode_merge">
                                    <strong>合併模式</strong> - 保留現有資料，只新增不存在的項目
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="import_mode" id="mode_replace" value="replace">
                                <label class="form-check-label" for="mode_replace">
                                    <strong>覆蓋模式</strong> - 更新已存在的項目 (慎用!)
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">選擇要匯入的資料類型</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="import_users" id="import_users" checked>
                                <label class="form-check-label" for="import_users">
                                    用戶資料
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="import_categories" id="import_categories" checked>
                                <label class="form-check-label" for="import_categories">
                                    分類
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="import_keywords" id="import_keywords" checked>
                                <label class="form-check-label" for="import_keywords">
                                    關鍵字 (包含別名和影片)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="import_navigation" id="import_navigation">
                                <label class="form-check-label" for="import_navigation">
                                    導航、底部連結、公告橫幅
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="import_settings" id="import_settings">
                                <label class="form-check-label" for="import_settings">
                                    網站設定
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="import_goals" id="import_goals">
                                <label class="form-check-label" for="import_goals">
                                    目標清單與項目
                                </label>
                            </div>
                        </div>

                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>警告:</strong> 匯入操作無法復原! 建議先備份現有資料。
                        </div>

                        <button type="submit" class="btn btn-warning btn-lg w-100" id="importBtn">
                            <i class="bi bi-upload"></i> 開始匯入
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 自動備份管理 -->
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-cloud-download"></i> 自動備份管理</h5>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <!-- 備份統計 -->
                <div class="col-md-12 mb-3">
                    <div class="row g-3">
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card">
                                <div class="stat-icon bg-primary">
                                    <i class="bi bi-files"></i>
                                </div>
                                <div class="stat-info">
                                    <h6 class="text-muted mb-1">總備份數</h6>
                                    <h4 class="mb-0">{{ backup_stats.total_backups }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card">
                                <div class="stat-icon bg-info">
                                    <i class="bi bi-arrow-repeat"></i>
                                </div>
                                <div class="stat-info">
                                    <h6 class="text-muted mb-1">自動備份</h6>
                                    <h4 class="mb-0">{{ backup_stats.auto_backups }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card">
                                <div class="stat-icon bg-success">
                                    <i class="bi bi-hand-thumbs-up"></i>
                                </div>
                                <div class="stat-info">
                                    <h6 class="text-muted mb-1">手動備份</h6>
                                    <h4 class="mb-0">{{ backup_stats.manual_backups }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card">
                                <div class="stat-icon bg-warning">
                                    <i class="bi bi-database"></i>
                                </div>
                                <div class="stat-info">
                                    <h6 class="text-muted mb-1">總容量</h6>
                                    <h4 class="mb-0">{{ backup_stats.total_size_formatted }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 建立手動備份 -->
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-plus-circle"></i> 建立手動備份</h6>
                        </div>
                        <div class="card-body">
                            <form action="{{ url_for('admin.create_backup') }}" method="post">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="mb-3">
                                    <label for="backup_description" class="form-label">備份說明 (選填)</label>
                                    <textarea class="form-control" id="backup_description" name="description" rows="2" placeholder="例如: 重要更新前備份"></textarea>
                                </div>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-cloud-download"></i> 立即建立備份
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 清理舊備份 -->
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="bi bi-trash"></i> 清理舊備份</h6>
                        </div>
                        <div class="card-body">
                            <form action="{{ url_for('admin.cleanup_old_backups') }}" method="post" id="cleanupForm">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="mb-3">
                                    <label for="retention_days" class="form-label">保留天數</label>
                                    <input type="number" class="form-control" id="retention_days" name="retention_days" value="30" min="1" max="365">
                                    <small class="form-text text-muted">只保留指定天數內的備份</small>
                                </div>
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="bi bi-trash"></i> 清理舊備份
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Discord Webhook 設定 -->
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-discord"></i> Discord 備份通知</h6>
                        </div>
                        <div class="card-body">
                            {% if backup_webhook_url %}
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle"></i> 已啟用備份推送。
                            </div>
                            {% else %}
                            <div class="alert alert-secondary" role="alert">
                                <i class="bi bi-bell"></i> 尚未設定 Webhook，填入後可於 Discord 接收備份通知。
                            </div>
                            {% endif %}
                            <form action="{{ url_for('admin.update_backup_webhook') }}" method="post">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="mb-3">
                                    <label for="webhook_url" class="form-label">Discord Webhook URL</label>
                                    <input type="url" class="form-control" id="webhook_url" name="webhook_url" placeholder="https://discord.com/api/webhooks/..." value="{{ backup_webhook_url }}" autocomplete="off">
                                    <small class="form-text text-muted">限使用 Discord 官方 Webhook，檔案將壓縮後傳送，超過 25MB 將僅推送通知。</small>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> 儲存設定
                                    </button>
                                    {% if backup_webhook_url %}
                                    <button type="submit" class="btn btn-outline-secondary" name="action" value="clear" onclick="return confirm('確定要停用 Discord 備份推送嗎？');">
                                        <i class="bi bi-x-circle"></i> 停用推送
                                    </button>
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 備份清單 -->
            {% if backups %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>檔案名稱</th>
                            <th>類型</th>
                            <th>建立時間</th>
                            <th>檔案大小</th>
                            <th>說明</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for backup in backups %}
                        <tr>
                            <td><code class="text-primary">{{ backup.filename }}</code></td>
                            <td>
                                {% if backup.backup_type == 'auto' %}
                                    <span class="badge bg-info"><i class="bi bi-arrow-repeat"></i> 自動</span>
                                {% else %}
                                    <span class="badge bg-success"><i class="bi bi-hand-thumbs-up"></i> 手動</span>
                                {% endif %}
                            </td>
                            <td>{{ backup.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ backup.get_display_size() }}</td>
                            <td>
                                {% if backup.description %}
                                    <small>{{ backup.description }}</small>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('admin.download_backup', backup_id=backup.id) }}" class="btn btn-outline-primary" title="下載">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <form action="{{ url_for('admin.delete_backup', backup_id=backup.id) }}" method="post" style="display: inline;" onsubmit="return confirm('確定要刪除此備份嗎?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-outline-danger" title="刪除">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle"></i> 尚未建立任何備份。系統將在每天午夜 1:00 自動建立備份。
            </div>
            {% endif %}
        </div>
    </div>

<style>
.stat-card {
    display: flex;
    align-items: center;
    padding: 1.25rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.5rem;
    color: white;
}

.stat-info h6 {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.stat-info h4 {
    font-size: 1.75rem;
    font-weight: 600;
}

.bg-purple {
    background-color: #6f42c1 !important;
}

.bg-teal {
    background-color: #20c997 !important;
}

.bg-orange {
    background-color: #fd7e14 !important;
}

.bg-cyan {
    background-color: #0dcaf0 !important;
}

.bg-indigo {
    background-color: #6610f2 !important;
}
</style>

<script>
document.getElementById('importForm').addEventListener('submit', function(e) {
    const mode = document.querySelector('input[name="import_mode"]:checked').value;
    const fileInput = document.getElementById('import_file');
    
    if (!fileInput.files.length) {
        e.preventDefault();
        alert('請選擇要匯入的檔案');
        return;
    }
    
    if (mode === 'replace') {
        if (!confirm('您選擇了覆蓋模式，這會更新現有的資料。確定要繼續嗎？')) {
            e.preventDefault();
            return;
        }
    }
    
    if (!confirm('確定要開始匯入資料嗎？此操作無法復原。')) {
        e.preventDefault();
        return;
    }
    
    // 顯示載入中
    const btn = document.getElementById('importBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 匯入中，請稍候...';
});

// 清理備份確認
document.getElementById('cleanupForm').addEventListener('submit', function(e) {
    const days = document.getElementById('retention_days').value;
    if (!confirm(`確定要刪除所有 ${days} 天以前的備份嗎? 此操作無法復原!`)) {
        e.preventDefault();
    }
});
</script>
{% endblock %}
