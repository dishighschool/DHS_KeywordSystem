{% extends "admin/base.html" %}
{% block title %}å…¬å‘Šæ©«å¹…ç®¡ç†{% endblock %}
{% block header_title %}å…¬å‘Šæ©«å¹…ç®¡ç†{% endblock %}
{% block page_icon_class %}bi bi-megaphone{% endblock %}
{% block page_title %}å…¬å‘Šæ©«å¹…ç®¡ç†{% endblock %}
{% block page_subtitle %}ç®¡ç†ç¶²ç«™å°èˆªåˆ—ä¸‹æ–¹çš„å…¬å‘Šæ©«å¹…ï¼Œæ”¯æ´å¤šå€‹å…¬å‘Šè¼ªæ’­{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-lg-4">
    <div class="admin-card sticky-top" style="top: 90px;">
      <div class="admin-card-header">
        <h2 class="admin-card-title">
          <i class="bi bi-plus-circle admin-card-icon"></i>
          æ–°å¢å…¬å‘Šæ©«å¹…
        </h2>
      </div>
      <div class="admin-card-body">
        <form method="post" action="{{ url_for('admin.add_announcement') }}">
          {{ form.hidden_tag() }}
          <div class="mb-3">
            {{ form.text.label(class_='form-label fw-semibold') }}
            {{ form.text(class_='form-control', placeholder='ğŸ‰ ç¶²ç«™ä¸Šç·šé€šçŸ¥', maxlength='200') }}
            <div class="form-text">æœ€å¤š 200 å­—å…ƒ</div>
            {% for error in form.text.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="mb-3">
            {{ form.url.label(class_='form-label fw-semibold') }}
            {{ form.url(class_='form-control', placeholder='https://example.com') }}
            <div class="form-text">é»æ“Šå…¬å‘Šæ™‚è·³è½‰çš„é€£çµï¼ˆé¸å¡«ï¼‰</div>
            {% for error in form.url.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="mb-3">
            {{ form.icon.label(class_='form-label fw-semibold') }}
            <div class="input-group">
              {{ form.icon(class_='form-control', id='announcementIcon', readonly='readonly', value='bi-info-circle-fill') }}
              <button type="button" class="btn btn-outline-secondary" onclick="openIconPicker('announcementIcon')">
                <i class="bi bi-search"></i> é¸æ“‡åœ–æ¨™
              </button>
            </div>
            <div class="form-text">
              <i id="announcementIconPreview" class="bi bi-info-circle-fill me-1" style="font-size: 1.2rem;"></i>
              åœ–æ¨™é è¦½
            </div>
            {% for error in form.icon.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="mb-3">
            <div class="form-check">
              {{ form.is_active(class_='form-check-input', checked=True) }}
              {{ form.is_active.label(class_='form-check-label') }}
            </div>
          </div>
          {{ form.submit(class_='btn btn-primary w-100') }}
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-lg-8">
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">
          <i class="bi bi-list-ul admin-card-icon"></i>
          ç¾æœ‰å…¬å‘Šæ©«å¹…
        </h2>
        <div class="text-muted small">å…± {{ announcements|length }} å€‹å…¬å‘Š</div>
      </div>
      <div class="admin-card-body p-0">
        {% if announcements %}
        <div class="list-group list-group-flush" id="announcementsList">
          {% for announcement in announcements %}
          <div class="list-group-item draggable-item" data-id="{{ announcement.id }}">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center flex-grow-1">
                <div class="drag-handle me-3 text-muted" style="cursor: move;" title="æ‹–å‹•èª¿æ•´é †åº">
                  <i class="bi bi-grip-vertical fs-4"></i>
                </div>
                <div class="me-3">
                  <div class="announcement-preview-md3">
                    <i class="bi {{ announcement.icon }}"></i>
                    <span>{{ announcement.text }}</span>
                  </div>
                </div>
                <div class="flex-grow-1">
                  {% if announcement.url %}
                  <small class="text-muted d-block">
                    <i class="bi bi-link-45deg"></i> {{ announcement.url }}
                  </small>
                  {% endif %}
                </div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge {% if announcement.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                  {% if announcement.is_active %}å•Ÿç”¨{% else %}åœç”¨{% endif %}
                </span>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                  onclick="toggleAnnouncement({{ announcement.id }})"
                  title="{% if announcement.is_active %}åœç”¨{% else %}å•Ÿç”¨{% endif %}">
                  <i class="bi {% if announcement.is_active %}bi-eye-slash{% else %}bi-eye{% endif %}"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary edit-btn" 
                  data-id="{{ announcement.id }}"
                  data-text="{{ announcement.text }}"
                  data-url="{{ announcement.url or '' }}"
                  data-icon="{{ announcement.icon }}"
                  data-is-active="{{ announcement.is_active|tojson }}"
                  title="ç·¨è¼¯">
                  <i class="bi bi-pencil"></i>
                </button>
                <form method="post" action="{{ url_for('admin.delete_announcement', announcement_id=announcement.id) }}" class="d-inline" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å‘Šæ©«å¹…å—ï¼Ÿ');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="bi bi-megaphone text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
          <p class="text-muted mt-3 mb-0">å°šæœªå»ºç«‹ä»»ä½•å…¬å‘Šæ©«å¹…ã€‚</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editAnnouncementModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">
          <i class="bi bi-pencil me-2"></i>ç·¨è¼¯å…¬å‘Šæ©«å¹…
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
      </div>
      <div class="modal-body">
        <form id="editAnnouncementForm">
          <input type="hidden" id="editAnnouncementId">
          <div class="mb-3">
            <label for="editText" class="form-label fw-semibold">å…¬å‘Šå…§å®¹ <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editText" maxlength="200" required>
          </div>
          <div class="mb-3">
            <label for="editUrl" class="form-label fw-semibold">é€£çµç¶²å€</label>
            <input type="url" class="form-control" id="editUrl">
            <div class="form-text">é»æ“Šå…¬å‘Šæ™‚è·³è½‰çš„é€£çµï¼ˆé¸å¡«ï¼‰</div>
          </div>
          <div class="mb-3">
            <label for="editIcon" class="form-label fw-semibold">åœ–æ¨™</label>
            <div class="input-group">
              <input type="text" class="form-control" id="editIcon" readonly>
              <button type="button" class="btn btn-outline-secondary" onclick="openIconPicker('editIcon')">
                <i class="bi bi-search"></i> é¸æ“‡åœ–æ¨™
              </button>
            </div>
            <div class="form-text">
              <i id="editIconPreview" class="bi bi-info-circle-fill me-1" style="font-size: 1.2rem;"></i>
              åœ–æ¨™é è¦½
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="editIsActive">
              <label class="form-check-label" for="editIsActive">å•Ÿç”¨é¡¯ç¤º</label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="saveEditBtn">
          <i class="bi bi-check-lg me-1"></i>å„²å­˜è®Šæ›´
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // åˆå§‹åŒ–æ‹–æ‹½æ’åº
  const announcementsList = document.getElementById('announcementsList');
  if (announcementsList) {
    new Sortable(announcementsList, {
      animation: 150,
      handle: '.drag-handle',
      onEnd: function(evt) {
        const order = Array.from(announcementsList.children).map(item => item.dataset.id);
        fetch('{{ url_for("admin.reorder_announcements") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order: order })
        });
      }
    });
  }
  
  // ç·¨è¼¯æŒ‰éˆ•é»æ“Šè™•ç†
  const editModal = new bootstrap.Modal(document.getElementById('editAnnouncementModal'));
  const editButtons = document.querySelectorAll('.edit-btn');
  
  editButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const text = this.dataset.text;
      const url = this.dataset.url;
      const icon = this.dataset.icon;
      const isActive = this.dataset.isActive === 'true';
      
      document.getElementById('editAnnouncementId').value = id;
      document.getElementById('editText').value = text;
      document.getElementById('editUrl').value = url;
      document.getElementById('editIcon').value = icon;
      document.getElementById('editIconPreview').className = 'bi ' + icon + ' me-1';
      document.getElementById('editIsActive').checked = isActive;
      
      editModal.show();
    });
  });
  
  // å„²å­˜ç·¨è¼¯
  document.getElementById('saveEditBtn').addEventListener('click', async function() {
    const id = document.getElementById('editAnnouncementId').value;
    const text = document.getElementById('editText').value.trim();
    const url = document.getElementById('editUrl').value.trim();
    const icon = document.getElementById('editIcon').value;
    const isActive = document.getElementById('editIsActive').checked;
    
    if (!text) {
      alert('è«‹å¡«å¯«å…¬å‘Šå…§å®¹');
      return;
    }
    
    try {
      const response = await fetch(`{{ url_for('admin.edit_announcement', announcement_id=0) }}`.replace('/0/', `/${id}/`), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text, url, icon, is_active: isActive })
      });
      
      const data = await response.json();
      
      if (data.success) {
        editModal.hide();
        location.reload();
      } else {
        alert(data.message || 'æ›´æ–°å¤±æ•—');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤');
    }
  });
});

// åˆ‡æ›å•Ÿç”¨/åœç”¨
function toggleAnnouncement(id) {
  fetch(`{{ url_for('admin.toggle_announcement', announcement_id=0) }}`.replace('/0/', `/${id}/`), {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('æ“ä½œå¤±æ•—');
  });
}

// Icon Picker åŠŸèƒ½
function openIconPicker(inputId) {
  const iconInput = document.getElementById(inputId);
  const previewId = inputId + 'Preview';
  const iconPreview = document.getElementById(previewId);
  
  if (typeof window.showIconPicker === 'function') {
    window.showIconPicker(function(selectedIcon) {
      iconInput.value = selectedIcon;
      if (iconPreview) {
        iconPreview.className = 'bi ' + selectedIcon + ' me-1';
      }
    });
  } else {
    console.error('Icon Picker not loaded');
    alert('åœ–æ¨™é¸æ“‡å™¨æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
  }
}

// ç›£è½æ–°å¢è¡¨å–®çš„åœ–æ¨™è¼¸å…¥è®ŠåŒ–
document.getElementById('announcementIcon').addEventListener('change', function() {
  const iconPreview = document.getElementById('announcementIconPreview');
  if (iconPreview && this.value) {
    iconPreview.className = 'bi ' + this.value + ' me-1';
  }
});
</script>

<script src="{{ url_for('static', filename='js/icon-picker.js') }}"></script>
</script>

<style>
/* MD3 Announcement Preview - Purple Theme */
.announcement-preview-md3 {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background-color: #E8DEF8;
  color: #1E192B;
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid #CAC4D0;
  font-size: 14px;
  font-weight: 500;
  letter-spacing: 0.1px;
  transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
}

.announcement-preview-md3:hover {
  background-color: #E0D5F5;
  border-color: #B8B0C8;
}

.announcement-preview-md3 i {
  font-size: 16px;
  color: #625B71;
  flex-shrink: 0;
}

.draggable-item {
  transition: background-color 0.2s cubic-bezier(0.2, 0, 0, 1);
}

.draggable-item:hover {
  background-color: rgba(103, 80, 164, 0.04);
}

.draggable-item.sortable-ghost {
  opacity: 0.4;
  background-color: rgba(103, 80, 164, 0.08);
}

.draggable-item.sortable-drag {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}
</style>
{% endblock %}
