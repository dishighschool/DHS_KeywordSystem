{% extends "admin/base.html" %}

{% block title %}{{ goal_list.name }}{% endblock %}

{% block page_title %}{{ goal_list.name }}{% endblock %}
{% block page_subtitle %}完成進度: {{ goal_list.completed_items }} / {{ goal_list.total_items }} ({{ "%.1f"|format(goal_list.completion_rate) }}%){% endblock %}
{% block page_icon_class %}bi bi-list-check{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* 基礎樣式 */
    .goal-item {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .goal-item:hover {
        background-color: #f8f9fa;
    }
    
    .goal-item.completed {
        background-color: #f0f8f0;
        border-left-color: #28a745;
    }
    
    .goal-item.completed .goal-item-title {
        text-decoration: line-through;
        color: #6c757d;
    }
    
    .completion-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* 搜尋和篩選區域樣式 */
    .search-filter-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .search-input-wrapper {
        position: relative;
        flex: 1;
        max-width: 500px;
    }
    
    .search-input-wrapper input {
        padding-right: 2.5rem;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .search-input-wrapper input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }
    
    .search-input-wrapper .input-group-text {
        background: white;
        border: 2px solid #dee2e6;
        border-right: none;
    }
    
    .search-input-wrapper input:focus ~ .input-group-text {
        border-color: #0d6efd;
    }
    
    .filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 0.375rem 1rem;
        border-radius: 2rem;
        border: 2px solid transparent;
        background: white;
        color: #6c757d;
        transition: all 0.3s ease;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .filter-btn.active {
        color: white;
    }
    
    .filter-btn.filter-all.active {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        border-color: #6c757d;
    }
    
    .filter-btn.filter-pending.active {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        border-color: #ffc107;
    }
    
    .filter-btn.filter-completed.active {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border-color: #28a745;
    }
    
    .search-stats {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border-radius: 2rem;
        border: 2px solid #dee2e6;
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .search-stats .stat-number {
        font-weight: 700;
        color: #0d6efd;
    }
    
    .clear-search-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: transparent;
        color: #6c757d;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
    }
    
    .clear-search-btn:hover {
        background: #e9ecef;
        color: #495057;
    }
    
    /* ============================================================================
       行動端優化 - 手機尺寸 (≤768px)
       ============================================================================ */
    @media (max-width: 768px) {
        /* 頂部按鈕區優化 */
        .d-flex.justify-content-between.mb-4 {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .d-flex.justify-content-between.mb-4 .btn-group {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .d-flex.justify-content-between.mb-4 .btn {
            flex: 1;
            min-width: calc(50% - 0.25rem);
            font-size: 0.8125rem;
            padding: 0.625rem 0.5rem;
            white-space: normal;
            line-height: 1.3;
            min-height: 44px;
        }
        
        .d-flex.justify-content-between.mb-4 .btn i {
            font-size: 0.875rem;
            display: block;
            margin: 0 auto 0.125rem;
        }
        
        .d-flex.justify-content-between.mb-4 .btn .me-2,
        .d-flex.justify-content-between.mb-4 .btn .me-1 {
            margin-right: 0 !important;
        }
        
        /* 資訊卡片優化 */
        .row.mb-4 {
            margin-bottom: 0.75rem !important;
        }
        
        .col-md-8,
        .col-md-4 {
            margin-bottom: 0.75rem;
        }
        
        .admin-card-body {
            padding: 1rem;
        }
        
        .progress {
            height: 8px !important;
        }
        
        /* 搜尋和篩選區優化 */
        .search-filter-section {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .d-flex.gap-3 {
            flex-direction: column !important;
            gap: 0.75rem !important;
        }
        
        .search-input-wrapper {
            max-width: 100%;
            order: 1;
        }
        
        .search-input-wrapper input {
            font-size: 0.9375rem;
            padding: 0.625rem;
        }
        
        .clear-search-btn {
            right: 0.375rem;
        }
        
        .filter-buttons {
            width: 100%;
            justify-content: flex-start;
            order: 2;
        }
        
        .filter-btn {
            font-size: 0.8125rem;
            padding: 0.375rem 0.875rem;
            flex: 1;
            min-width: calc(33.333% - 0.334rem);
            text-align: center;
        }
        
        .search-stats {
            width: 100%;
            justify-content: center;
            order: 3;
            font-size: 0.8125rem;
            padding: 0.5rem 0.875rem;
        }
        
        /* 目標項目列表優化 */
        .goal-item {
            padding: 0.875rem !important;
            border-left-width: 3px !important;
        }
        
        .goal-item .d-flex {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .goal-item .d-flex > div:first-child {
            width: 100%;
        }
        
        .goal-item-title {
            font-size: 0.9375rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .goal-item small {
            font-size: 0.8125rem;
            line-height: 1.4;
        }
        
        .goal-item .btn-group {
            width: 100%;
            display: flex;
            gap: 0.375rem;
        }
        
        .goal-item .btn {
            flex: 1;
            font-size: 0.8125rem;
            padding: 0.625rem 0.5rem;
            white-space: nowrap;
            min-height: 44px;
        }
        
        .goal-item .btn i {
            font-size: 0.9375rem;
        }
        
        .completion-badge {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        /* 分頁優化 */
        .pagination {
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .pagination .page-item {
            margin: 0 !important;
        }
        
        .pagination .page-link {
            padding: 0.375rem 0.625rem;
            font-size: 0.875rem;
        }
        
        /* 隱藏部分分頁按鈕在小螢幕 */
        .pagination .page-item:not(.active):not(:first-child):not(:last-child):not(:nth-child(2)):not(:nth-last-child(2)) {
            display: none;
        }
        
        /* 每頁顯示數量選擇器 */
        .d-flex.align-items-center.gap-2 select {
            font-size: 0.875rem;
            padding: 0.375rem 0.625rem;
        }
        
        /* 模態框優化 */
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-body input,
        .modal-body textarea {
            font-size: 0.9375rem;
        }
        
        .modal-footer {
            padding: 0.75rem 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .modal-footer .btn {
            flex: 1;
            min-width: calc(50% - 0.25rem);
        }
        
        /* 別名搜尋結果優化 */
        #aliasResults .list-group-item {
            padding: 0.75rem !important;
            font-size: 0.875rem;
        }
        
        #aliasResults .fw-semibold {
            font-size: 0.9375rem;
        }
        
        #aliasResults small {
            font-size: 0.75rem;
        }
        
        /* 空狀態優化 */
        #noResultsMessage {
            padding: 2rem 1rem !important;
        }
        
        #noResultsMessage i {
            font-size: 2.5rem !important;
        }
        
        #noResultsMessage p {
            font-size: 0.9375rem;
        }
    }
    
    @media (max-width: 480px) {
        .d-flex.justify-content-between.mb-4 .btn {
            min-width: 100%;
            font-size: 0.75rem;
            padding: 0.625rem 0.375rem;
        }
        
        .d-flex.justify-content-between.mb-4 .btn i {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .filter-btn {
            min-width: calc(50% - 0.25rem);
            font-size: 0.75rem;
            padding: 0.5rem 0.625rem;
        }
        
        .goal-item-title {
            font-size: 0.875rem;
        }
        
        .goal-item .btn {
            font-size: 0.75rem;
            padding: 0.5rem 0.375rem;
        }
        
        .pagination .page-link {
            padding: 0.3125rem 0.5rem;
            font-size: 0.8125rem;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{{ url_for('admin.manage_goal_lists') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>返回清單列表
    </a>
    
    {% if goal_list.created_by == current_user.id or current_user.is_admin() %}
    <div class="btn-group">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editListModal">
            <i class="bi bi-pencil me-2"></i>編輯清單資訊
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemsModal">
            <i class="bi bi-plus-circle me-2"></i>新增項目
        </button>
        <button class="btn btn-outline-{{ 'danger' if goal_list.is_active else 'success' }} js-toggle-list" 
                data-list-id="{{ goal_list.id }}">
            <i class="bi bi-toggle-{{ 'on' if goal_list.is_active else 'off' }} me-1"></i>
            {{ '停用' if goal_list.is_active else '啟用' }}
        </button>
        <button class="btn btn-outline-danger js-delete-list" 
                data-list-id="{{ goal_list.id }}">
            <i class="bi bi-trash me-1"></i>刪除清單
        </button>
    </div>
    {% endif %}
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="admin-card">
            <div class="admin-card-body">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-folder me-2 text-primary" style="font-size: 1.5rem;"></i>
                    <div>
                        <h6 class="mb-0">目標分類</h6>
                        <span class="text-muted">{{ goal_list.category_name }}</span>
                    </div>
                </div>
                
                {% if goal_list.description %}
                <div class="mb-3">
                    <h6 class="fw-bold">說明</h6>
                    <p class="text-muted mb-0">{{ goal_list.description }}</p>
                </div>
                {% endif %}
                
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success progress-bar-striped {% if goal_list.completion_rate < 100 %}progress-bar-animated{% endif %}" 
                         role="progressbar" 
                         style="width: {{ goal_list.completion_rate }}%"
                         aria-valuenow="{{ goal_list.completion_rate }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ "%.1f"|format(goal_list.completion_rate) }}%
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="admin-card">
            <div class="admin-card-body">
                <h6 class="fw-bold mb-3">統計資訊</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">總計</span>
                    <span class="fw-bold">{{ goal_list.total_items }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-success">已完成</span>
                    <span class="fw-bold text-success">{{ goal_list.completed_items }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="text-warning">待完成</span>
                    <span class="fw-bold text-warning">{{ goal_list.total_items - goal_list.completed_items }}</span>
                </div>
                
                <hr>
                
                <div class="d-flex justify-content-between text-muted small">
                    <span>創建者</span>
                    <span>{{ goal_list.creator.username }}</span>
                </div>
                <div class="d-flex justify-content-between text-muted small">
                    <span>創建時間</span>
                    <span>{{ goal_list.created_at.strftime('%Y-%m-%d') }}</span>
                </div>
                <div class="d-flex justify-content-between text-muted small">
                    <span>狀態</span>
                    <span class="badge bg-{{ 'success' if goal_list.is_active else 'secondary' }}">
                        {{ '啟用中' if goal_list.is_active else '已停用' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="admin-card">
    <div class="admin-card-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="admin-card-title mb-0">
                <i class="admin-card-icon bi bi-list-ul"></i>
                關鍵字列表
            </h5>
            {% if pagination.pages > 1 %}
            <div class="d-flex align-items-center gap-2">
                <small class="text-muted">每頁:</small>
                <select class="form-select form-select-sm" id="perPageSelect" style="width: auto;">
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
            {% endif %}
        </div>
        
        <!-- 搜尋和篩選功能 -->
        <form method="get" id="searchFilterForm" class="search-filter-section">
            <div class="d-flex gap-3 align-items-center flex-wrap">
                <!-- 搜尋框 -->
                <div class="search-input-wrapper">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="bi bi-search text-primary"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               name="search" 
                               id="itemSearchInput" 
                               placeholder="搜尋關鍵字標題..."
                               value="{{ search_query }}">
                        {% if search_query %}
                        <button class="clear-search-btn" type="button" id="clearSearchBtn" title="清除搜尋">
                            <i class="bi bi-x-circle-fill"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 狀態篩選按鈕 -->
                <div class="filter-buttons">
                    <button type="button" 
                            class="filter-btn filter-all {% if status_filter == 'all' %}active{% endif %}" 
                            data-status="all">
                        <i class="bi bi-list-ul me-1"></i>全部
                    </button>
                    <button type="button" 
                            class="filter-btn filter-pending {% if status_filter == 'pending' %}active{% endif %}" 
                            data-status="pending">
                        <i class="bi bi-clock me-1"></i>待完成
                    </button>
                    <button type="button" 
                            class="filter-btn filter-completed {% if status_filter == 'completed' %}active{% endif %}" 
                            data-status="completed">
                        <i class="bi bi-check-circle me-1"></i>已完成
                    </button>
                </div>
                
                <!-- 搜尋統計 -->
                <div class="search-stats ms-auto">
                    <i class="bi bi-info-circle text-primary"></i>
                    <span>顯示 <span class="stat-number">{{ pagination.total }}</span> / <span class="stat-number">{{ goal_list.total_items }}</span> 項</span>
                </div>
            </div>
            <input type="hidden" name="status" id="statusInput" value="{{ status_filter }}">
            <input type="hidden" name="per_page" value="{{ per_page }}">
        </form>
    </div>
    <div class="admin-card-body p-0">
        {% if pagination.items %}
        <div class="list-group list-group-flush" id="itemsList">
            {% for item in pagination.items %}
            <div class="list-group-item goal-item {% if item.is_completed %}completed{% endif %}" 
                 data-item-id="{{ item.id }}">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <span class="badge bg-secondary item-index">{{ ((pagination.page - 1) * per_page) + loop.index }}</span>
                    </div>
                    
                    <div class="flex-grow-1">
                        <h6 class="mb-1 goal-item-title">{{ item.title }}</h6>
                        {% if item.is_completed %}
                        <small class="text-muted">
                            <i class="bi bi-check-circle-fill text-success me-1"></i>
                            由 {{ item.completer.username }} 於 {{ item.completed_at.strftime('%Y-%m-%d %H:%M') }} 完成
                            {% if item.keyword %}
                            · <a href="{{ url_for('admin.edit_keyword_studio', keyword_id=item.keyword_id) }}" 
                                 class="text-decoration-none">查看關鍵字</a>
                            {% endif %}
                        </small>
                        {% endif %}
                    </div>
                    
                    <div class="ms-3">
                        {% if item.is_completed %}
                        <span class="completion-badge badge bg-success">已完成</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2 js-mark-incomplete" 
                                data-item-id="{{ item.id }}"
                                title="取消完成">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        {% if item.keyword %}
                        <a href="{{ url_for('admin.edit_keyword_studio', keyword_id=item.keyword_id) }}" 
                           class="btn btn-sm btn-primary ms-2">
                            <i class="bi bi-pencil me-1"></i>編輯
                        </a>
                        {% endif %}
                        {% else %}
                        <a href="{{ url_for('admin.prepare_create_from_goal', item_id=item.id) }}" 
                           class="btn btn-sm btn-success"
                           title="在編輯器中創建">
                            <i class="bi bi-plus-circle me-1"></i>創建
                        </a>
                        <button class="btn btn-sm btn-outline-primary ms-2 js-open-alias-modal"
                                data-item-id="{{ item.id }}"
                                data-item-title="{{ item.title }}"
                                title="搜尋既有關鍵字並設定為別名">
                            <i class="bi bi-link-45deg me-1"></i>設定別名
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2 js-mark-complete"
                                data-item-id="{{ item.id }}"
                                title="手動標記為完成">
                            <i class="bi bi-check-lg"></i>
                        </button>
                        {% if goal_list.created_by == current_user.id or current_user.is_admin() %}
                        <button class="btn btn-sm btn-outline-danger ms-2 js-delete-item" 
                                data-item-id="{{ item.id }}"
                                data-item-title="{{ item.title }}"
                                title="刪除此項目">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5" id="noResultsMessage">
            <i class="bi bi-search" style="font-size: 3rem; color: #dee2e6;"></i>
            <p class="text-muted mt-3 mb-2">
                {% if search_query or status_filter != 'all' %}
                找不到符合的項目
                {% else %}
                此清單尚無項目
                {% endif %}
            </p>
            {% if search_query or status_filter != 'all' %}
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="clearSearchAndFilter()">
                <i class="bi bi-arrow-counterclockwise me-1"></i>清除篩選
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    {% if pagination.pages > 1 %}
    <div class="admin-card-footer">
        <nav>
            <ul class="pagination pagination-sm justify-content-center mb-0">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.view_goal_list', list_id=goal_list.id, page=pagination.prev_num, per_page=per_page, search=search_query, status=status_filter) }}">
                        <i class="bi bi-chevron-left"></i> 上一頁
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link"><i class="bi bi-chevron-left"></i> 上一頁</span>
                </li>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('admin.view_goal_list', list_id=goal_list.id, page=page_num, per_page=per_page, search=search_query, status=status_filter) }}">
                            {{ page_num }}
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.view_goal_list', list_id=goal_list.id, page=pagination.next_num, per_page=per_page, search=search_query, status=status_filter) }}">
                        下一頁 <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">下一頁 <i class="bi bi-chevron-right"></i></span>
                </li>
                {% endif %}
            </ul>
        </nav>
        
        <div class="text-center mt-2">
            <small class="text-muted">
                第 {{ pagination.page }} / {{ pagination.pages }} 頁，
                共 {{ pagination.total }} 個項目
            </small>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="aliasModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-link-45deg me-2"></i>設定別名
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">選擇要掛接的既有關鍵字後，系統會建立別名並標記此目標為完成。</p>
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="aliasSearchInput" placeholder="輸入關鍵字標題或別名進行搜尋">
                </div>
                <div class="mb-3">
                    <span class="fw-semibold">目前項目：</span>
                    <span id="aliasModalCurrentTitle" class="badge bg-light text-dark ms-1"></span>
                </div>
                <div id="aliasSearchStatus" class="text-muted small">輸入至少兩個字元開始搜尋。</div>
                <div id="aliasResults" class="list-group mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editListModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>編輯清單資訊
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editListForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="listName" class="form-label">清單名稱 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="listName" value="{{ goal_list.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="listDescription" class="form-label">說明</label>
                        <textarea class="form-control" id="listDescription" rows="3">{{ goal_list.description or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="listCategory" class="form-label">目標分類 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="listCategory" value="{{ goal_list.category_name }}" required>
                        <div class="form-text">所有項目將使用此分類創建關鍵字</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>儲存變更
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addItemsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>新增目標項目
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addItemsForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newItems" class="form-label">關鍵字列表 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="newItems" rows="10" placeholder="請輸入關鍵字,每行一個&#10;例如:&#10;淨灘&#10;精緻&#10;創作者" required></textarea>
                        <div class="form-text">每行輸入一個關鍵字標題,將依序新增到清單末尾</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i>新增項目
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    console.log('Goal list detail script loaded');
    
    // ========== 全域變數 ==========
    let aliasModal = null;
    let currentItemId = null;
    let searchTimer = null;
    
    // ========== 初始化 ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM ready, initializing...');
        
        // 初始化別名模態框
        initAliasModal();
        
        // 綁定表單事件
        bindFormEvents();
        
        // 設置事件委託
        setupEventDelegation();
        
        console.log('Initialization complete');
    });
    
    // ========== 別名模態框初始化 ==========
    function initAliasModal() {
        const modalEl = document.getElementById('aliasModal');
        const searchInput = document.getElementById('aliasSearchInput');
        
        if (!modalEl) {
            console.warn('Alias modal element not found');
            return;
        }
        
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap is not loaded');
            return;
        }
        
        try {
            aliasModal = new bootstrap.Modal(modalEl);
            console.log('Alias modal initialized');
            
            // 模態框顯示時自動聚焦搜尋框
            modalEl.addEventListener('shown.bs.modal', function() {
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            });
            
            // 綁定搜尋輸入事件
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.trim();
                    scheduleSearch(query);
                });
            }
        } catch (error) {
            console.error('Failed to initialize alias modal:', error);
        }
    }
    
    // ========== 搜尋功能 ==========
    function scheduleSearch(query) {
        if (searchTimer) {
            clearTimeout(searchTimer);
        }
        
        searchTimer = setTimeout(function() {
            performSearch(query);
        }, 300);
    }
    
    function performSearch(query) {
        const resultsContainer = document.getElementById('aliasResults');
        const statusEl = document.getElementById('aliasSearchStatus');
        
        if (!resultsContainer || !statusEl) return;
        
        // 清空之前的結果
        resultsContainer.innerHTML = '';
        
        if (!query || query.length < 2) {
            statusEl.textContent = '輸入至少兩個字元開始搜尋。';
            statusEl.className = 'text-muted small';
            return;
        }
        
        statusEl.textContent = '搜尋中...';
        statusEl.className = 'text-muted small';
        
        fetch('/admin/goal-items/keyword-search?q=' + encodeURIComponent(query))
            .then(function(response) {
                if (!response.ok) throw new Error('搜尋請求失敗');
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    displaySearchResults(data.results || []);
                } else {
                    statusEl.textContent = data.message || '搜尋失敗';
                    statusEl.className = 'text-danger small';
                }
            })
            .catch(function(error) {
                console.error('Search error:', error);
                statusEl.textContent = '搜尋失敗，請稍後再試';
                statusEl.className = 'text-danger small';
            });
    }
    
    function displaySearchResults(results) {
        const resultsContainer = document.getElementById('aliasResults');
        const statusEl = document.getElementById('aliasSearchStatus');
        
        if (!resultsContainer || !statusEl) return;
        
        resultsContainer.innerHTML = '';
        
        if (results.length === 0) {
            statusEl.textContent = '找不到符合的關鍵字';
            statusEl.className = 'text-danger small';
            return;
        }
        
        statusEl.textContent = '找到 ' + results.length + ' 個結果，點擊要掛接的關鍵字';
        statusEl.className = 'text-muted small';
        
        results.forEach(function(item) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-start';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'me-3';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'fw-semibold';
            titleDiv.textContent = item.title || '';
            textDiv.appendChild(titleDiv);
            
            if (item.category) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'text-muted small';
                if (item.category_icon) {
                    const icon = document.createElement('i');
                    icon.className = item.category_icon + ' me-1';
                    metaDiv.appendChild(icon);
                }
                metaDiv.appendChild(document.createTextNode(item.category));
                textDiv.appendChild(metaDiv);
            }
            
            btn.appendChild(textDiv);
            
            if (item.match_label) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary text-white';
                badge.textContent = item.match_label;
                btn.appendChild(badge);
            }
            
            btn.onclick = function() {
                selectKeyword(item.id, item.title);
            };
            
            resultsContainer.appendChild(btn);
        });
    }
    
    function selectKeyword(keywordId, keywordTitle) {
        const currentTitle = document.getElementById('aliasModalCurrentTitle');
        const titleText = currentTitle ? currentTitle.textContent : '';
        
        if (!confirm('確定要將「' + titleText + '」設定為「' + keywordTitle + '」的別名並標記此項目為完成嗎?')) {
            return;
        }
        
        const statusEl = document.getElementById('aliasSearchStatus');
        if (statusEl) {
            statusEl.textContent = '處理中，請稍候...';
            statusEl.className = 'text-muted small';
        }
        
        fetch('/admin/goal-items/' + currentItemId + '/attach-alias', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ keyword_id: keywordId })
        })
        .then(function(response) {
            if (!response.ok) throw new Error('請求失敗');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                alert(data.message || '設定成功');
                location.reload();
            } else {
                throw new Error(data.message || '設定失敗');
            }
        })
        .catch(function(error) {
            console.error('Attach alias error:', error);
            if (statusEl) {
                statusEl.textContent = '設定失敗：' + error.message;
                statusEl.className = 'text-danger small';
            }
        });
    }
    
    // ========== 表單事件綁定 ==========
    function bindFormEvents() {
        // 編輯清單表單
        const editForm = document.getElementById('editListForm');
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const listId = {{ goal_list.id }};
                const formData = {
                    name: document.getElementById('listName').value.trim(),
                    description: document.getElementById('listDescription').value.trim(),
                    category_name: document.getElementById('listCategory').value.trim()
                };
                
                if (!formData.name || !formData.category_name) {
                    alert('請填寫必填欄位');
                    return;
                }
                
                fetch('/admin/goal-lists/' + listId + '/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(formData)
                })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || '更新失敗');
                    }
                })
                .catch(function(err) {
                    console.error(err);
                    alert('更新失敗');
                });
            });
        }
        
        // 新增項目表單
        const addForm = document.getElementById('addItemsForm');
        if (addForm) {
            addForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const listId = {{ goal_list.id }};
                const itemsText = document.getElementById('newItems').value.trim();
                
                if (!itemsText) {
                    alert('請輸入至少一個關鍵字');
                    return;
                }
                
                const items = itemsText.split('\n')
                    .map(function(line) { return line.trim(); })
                    .filter(function(line) { return line.length > 0; });
                
                if (items.length === 0) {
                    alert('請輸入至少一個關鍵字');
                    return;
                }
                
                fetch('/admin/goal-lists/' + listId + '/add-items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ items: items })
                })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success) {
                        alert('已新增 ' + data.count + ' 個項目');
                        location.reload();
                    } else {
                        alert(data.message || '新增失敗');
                    }
                })
                .catch(function(err) {
                    console.error(err);
                    alert('新增失敗');
                });
            });
        }
    }
    
    // ========== 事件委託 ==========
    function setupEventDelegation() {
        document.addEventListener('click', function(e) {
            const target = e.target.closest('button');
            if (!target) return;
            
            // 開啟別名模態框
            if (target.classList.contains('js-open-alias-modal')) {
                e.preventDefault();
                const itemId = target.dataset.itemId;
                const itemTitle = target.dataset.itemTitle;
                openAliasModalHandler(itemId, itemTitle);
            }
            
            // 標記完成
            else if (target.classList.contains('js-mark-complete')) {
                e.preventDefault();
                const itemId = target.dataset.itemId;
                markCompleteHandler(itemId);
            }
            
            // 取消完成
            else if (target.classList.contains('js-mark-incomplete')) {
                e.preventDefault();
                const itemId = target.dataset.itemId;
                markIncompleteHandler(itemId);
            }
            
            // 刪除項目
            else if (target.classList.contains('js-delete-item')) {
                e.preventDefault();
                const itemId = target.dataset.itemId;
                const itemTitle = target.dataset.itemTitle;
                deleteItemHandler(itemId, itemTitle);
            }
            
            // 切換清單
            else if (target.classList.contains('js-toggle-list')) {
                e.preventDefault();
                const listId = target.dataset.listId;
                toggleGoalListHandler(listId);
            }
            
            // 刪除清單
            else if (target.classList.contains('js-delete-list')) {
                e.preventDefault();
                const listId = target.dataset.listId;
                deleteGoalListHandler(listId);
            }
        });
    }
    
    // ========== 處理函數 ==========
    function openAliasModalHandler(itemId, itemTitle) {
        console.log('openAliasModal called:', itemId, itemTitle);
        
        if (!aliasModal) {
            alert('系統錯誤：模態框未初始化');
            return;
        }
        
        currentItemId = itemId;
        
        const titleEl = document.getElementById('aliasModalCurrentTitle');
        if (titleEl) titleEl.textContent = itemTitle || '';
        
        const searchInput = document.getElementById('aliasSearchInput');
        if (searchInput) searchInput.value = '';
        
        const resultsContainer = document.getElementById('aliasResults');
        if (resultsContainer) resultsContainer.innerHTML = '';
        
        const statusEl = document.getElementById('aliasSearchStatus');
        if (statusEl) {
            statusEl.textContent = '輸入至少兩個字元開始搜尋。';
            statusEl.className = 'text-muted small';
        }
        
        aliasModal.show();
    }
    
    function toggleGoalListHandler(listId) {
        fetch('/admin/goal-lists/' + listId + '/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '操作失敗');
            }
        })
        .catch(function(err) {
            console.error(err);
            alert('操作失敗');
        });
    }
    
    function deleteGoalListHandler(listId) {
        if (!confirm('確定要刪除此目標清單嗎?\n所有未完成的項目也將被刪除。\n此操作無法復原!')) {
            return;
        }
        
        fetch('/admin/goal-lists/' + listId + '/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                window.location.href = '{{ url_for("admin.manage_goal_lists") }}';
            } else {
                alert(data.message || '刪除失敗');
            }
        })
        .catch(function(err) {
            console.error(err);
            alert('刪除失敗');
        });
    }
    
    function deleteItemHandler(itemId, title) {
        if (!confirm('確定要刪除項目「' + title + '」嗎?\n此操作無法復原!')) {
            return;
        }
        
        fetch('/admin/goal-items/' + itemId + '/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '刪除失敗');
            }
        })
        .catch(function(err) {
            console.error(err);
            alert('刪除失敗');
        });
    }
    
    function markCompleteHandler(itemId) {
        fetch('/admin/goal-items/' + itemId + '/mark-complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '操作失敗');
            }
        })
        .catch(function(err) {
            console.error(err);
            alert('操作失敗');
        });
    }
    
    function markIncompleteHandler(itemId) {
        if (!confirm('確定要取消完成標記嗎?')) {
            return;
        }
        
        fetch('/admin/goal-items/' + itemId + '/mark-incomplete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '操作失敗');
            }
        })
        .catch(function(err) {
            console.error(err);
            alert('操作失敗');
        });
    }
    
    // ========== 每頁顯示數量變更 ==========
    const perPageSelect = document.getElementById('perPageSelect');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', function() {
            const form = document.getElementById('searchFilterForm');
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('per_page', this.value);
            currentUrl.searchParams.set('page', '1');
            window.location.href = currentUrl.toString();
        });
    }
    
    // ========== 搜尋和篩選功能 ==========
    const searchForm = document.getElementById('searchFilterForm');
    const searchInput = document.getElementById('itemSearchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const statusInput = document.getElementById('statusInput');
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    // 搜尋輸入處理 - 使用防抖延遲提交
    let searchTimeout;
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                searchForm.submit();
            }, 500);  // 500ms 延遲
        });
        
        // Enter 鍵立即提交
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(searchTimeout);
                searchForm.submit();
            }
        });
    }
    
    // 清除搜尋按鈕
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchForm.submit();
        });
    }
    
    // 狀態篩選按鈕
    filterButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            
            // 更新按鈕狀態
            filterButtons.forEach(function(b) {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // 更新隱藏的 input 值
            statusInput.value = status;
            
            // 提交表單
            searchForm.submit();
        });
    });
    
    // 全域清除函數
    window.clearSearchAndFilter = function() {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('search');
        currentUrl.searchParams.delete('status');
        currentUrl.searchParams.set('page', '1');
        window.location.href = currentUrl.toString();
    };
})();
</script>
{% endblock %}
